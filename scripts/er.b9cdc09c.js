!function(){"use strict";function a(a,b,d,e,f,g){e.debugInfoEnabled(f),g.debugEnabled(f),angular.extend(d,{autoDismiss:!0,closeButton:!0,positionClass:"toast-top-right",progressBar:!0,timeOut:7e3}),a.state("er",{url:"","abstract":!0,resolve:{user:c},views:{navigationBar:{templateUrl:"mantenedor.base.navigation_topbar.html"},infoBar:{templateUrl:"mantenedor.base.infobar.html"}}})}function b(a,b,c,d){d.enabled(!1),a.promises={},a.$on("$viewContentLoaded",function(){$(document).ready(function(){$(document).foundation()})}),a.tiposGlobales={serviciosSalud:null,tiposDeReceta:null},a.loadingReady={user:!1,servicios:!1,receta:!1},a.cargaInicial=function(){var b=!0;a.loadingReady.servicios||(b=!1),a.loadingReady.user||(b=!1),a.loadingReady.receta||(b=!1),b&&$("#contenedor-carga").hide()},a.eliminarPermisosDuplicados=function(a){for(var b=[],c=0;c<a.length;c++){var d=b.filter(function(b){return b==a[c]});0==d.length&&b.push(a[c])}return b}}function c(a,b,c){return a.user={ready:!1},b.getListaTREC().then(function(b){a.tiposGlobales.tiposDeReceta=b.data,a.loadingReady.receta=!0,a.cargaInicial()})["catch"](function(b){a.loadingReady.receta=!0,a.cargaInicial()}),b.getServiciosSalud().then(function(b){a.tiposGlobales.serviciosSalud=b.data,a.loadingReady.servicios=!0,a.cargaInicial()})["catch"](function(b){a.loadingReady.servicios=!0,a.cargaInicial()}),b.getListaROLES().then(function(d){return a.tiposGlobales.perfiles=d.data,b.getRolesPermisos().then(function(d){for(var e=0;e<a.tiposGlobales.perfiles.length;e++){var f=d.data.filter(function(b){return b.ID==a.tiposGlobales.perfiles[e].Id});if(a.tiposGlobales.perfiles[e].Permisos=[],f.length>0)for(var g=0;g<f.length;g++)a.tiposGlobales.perfiles[e].Permisos.push(f[g].PERMISO)}return b.getUSER().then(function(d){null==d.data.Nodos||""==d.data.Nodos?d.data.Nodos=[]:d.data.Nodos=d.data.Nodos.split(","),null==d.data.Permisos||""==d.data.Permisos?d.data.Permisos=[]:d.data.Permisos=d.data.Permisos.split(","),null==d.data.Restricciones||""==d.data.Restricciones?d.data.Restricciones=[]:d.data.Restricciones=d.data.Restricciones.split(",");for(var e=0;e<d.data.Roles.length;e++)for(var f=0;f<a.tiposGlobales.perfiles.length;f++)if(a.tiposGlobales.perfiles[f].Name==d.data.Roles[e]){var g=a.joinArrays(d.data.Permisos,a.tiposGlobales.perfiles[f].Permisos);d.data.Permisos=g}d.data.Permisos=a.eliminarPermisosDuplicados(d.data.Permisos);for(var e=0;e<d.data.Restricciones.length;e++){var f=d.data.Permisos.indexOf(d.data.Restricciones[e]);f>-1&&d.data.Permisos.splice(f,1)}a.user={Id:d.data.AspNetUserId,data:d.data,ready:!0,permisos:{listarArticulo:d.data.Permisos.indexOf(c.MANTENEDOR.CONSULTAR_ARTICULO)>-1?!0:!1,solicitarArticulo:d.data.Permisos.indexOf(c.MANTENEDOR.CREAR_SOLICITUD_ARTICULO)>-1?!0:!1,crearArticulo:d.data.Permisos.indexOf(c.MANTENEDOR.CREAR_ARTICULO)>-1?!0:!1,aprobarSolicitudFarmaco:d.data.Permisos.indexOf(c.MANTENEDOR.APROBAR_SOLICITUD_FARMACO)>-1?!0:!1,aprobarSolicitudInsumo:d.data.Permisos.indexOf(c.MANTENEDOR.APROBAR_SOLICITUD_INSUMO)>-1?!0:!1,listarSolicitudes:d.data.Permisos.indexOf(c.MANTENEDOR.CONSULTAR_SOLICITUD_ARTICULO)>-1?!0:!1,pasivarArticulo:d.data.Permisos.indexOf(c.MANTENEDOR.PASIVAR_ARTICULO)>-1?!0:!1,listarReceta:d.data.Permisos.indexOf(c.MANTENEDOR.LISTAR_RECETA)>-1?!0:!1,modificarReceta:d.data.Permisos.indexOf(c.MANTENEDOR.MODIFICAR_RECETA)>-1?!0:!1,eliminarReceta:d.data.Permisos.indexOf(c.MANTENEDOR.ELIMINAR_RECETA)>-1?!0:!1,agregarReceta:d.data.Permisos.indexOf(c.MANTENEDOR.AGREGAR_RECETA)>-1?!0:!1,crearPerfil:d.data.Permisos.indexOf(c.MANTENEDOR.CREAR_PERFIL)>-1?!0:!1,modificarPerfil:d.data.Permisos.indexOf(c.MANTENEDOR.MODIFICAR_PERFIL)>-1?!0:!1,eliminarPerfil:d.data.Permisos.indexOf(c.MANTENEDOR.DESACTIVAR_PERFIL)>-1?!0:!1,listarPerfil:d.data.Permisos.indexOf(c.MANTENEDOR.LISTAR_PERFIL)>-1?!0:!1,listarUsuario:d.data.Permisos.indexOf(c.MANTENEDOR.LISTAR_USUARIO)>-1?!0:!1,crearUsuario:d.data.Permisos.indexOf(c.MANTENEDOR.CREAR_USUARIO)>-1?!0:!1,modificarUsuario:d.data.Permisos.indexOf(c.MANTENEDOR.MODIFICAR_USUARIO)>-1?!0:!1,desactivarUsuario:d.data.Permisos.indexOf(c.MANTENEDOR.DESACTIVAR_USUARIO)>-1?!0:!1,listarConsulta:d.data.Permisos.indexOf(c.MANTENEDOR.LISTAR_TIPOS_CONSULTA)>-1?!0:!1,modificarConsulta:d.data.Permisos.indexOf(c.MANTENEDOR.MODIFICAR_TIPO_CONSULTA)>-1?!0:!1,eliminarConsulta:d.data.Permisos.indexOf(c.MANTENEDOR.ELIMINAR_TIPO_CONSULTA)>-1?!0:!1,agregarConsulta:d.data.Permisos.indexOf(c.MANTENEDOR.AGREGAR_TIPO_CONSULTA)>-1?!0:!1,listarParametro:d.data.Permisos.indexOf(c.MANTENEDOR.LISTAR_PARAMETRO)>-1?!0:!1,modificarParametro:d.data.Permisos.indexOf(c.MANTENEDOR.MODIFICAR_PARAMETRO)>-1?!0:!1,desactivarParametro:d.data.Permisos.indexOf(c.MANTENEDOR.DESACTIVAR_PARAMETRO)>-1?!0:!1},tieneFarmaciaPopular:!1,validarFarmaciaPopular:function(){for(var c=Math.ceil(d.data.Nodos.length/10),e=0;c>e;e++)b.getNOD(d.data.Nodos.slice(0+c*e,10+c*e)).then(function(b){var c=0;for(c=0;c<b.data.length;c++)if(20==b.data[c].TIPO||3==b.data[c].TIPO)return a.user.tieneFarmaciaPopular=!0,a.loadingReady.user=!0,void a.cargaInicial();a.loadingReady.user=!0,a.cargaInicial()})["catch"](function(b){a.loadingReady.user=!0,a.cargaInicial()})}},a.user.validarFarmaciaPopular()})})})}angular.module("mantenedorApp",["ui.router","mm.foundation","ngAnimate","toastr","sdx.errors","sdx.constants","sdx.utils","sdx.data","sdx.login","mantenedorAdmission","mantenedorSolicitud","mantenedorSolicitudFarmaco","mantenedorSolicitudInsumo","mantenedorRecipe","mantenedorConsulta","mantenedorParametros","mantenedorArsenal","mantenedorAdmUsuario","mantenedorAdmPerfil","ngAria"]).config(a).run(b),a.$inject=["$stateProvider","$urlRouterProvider","toastrConfig","$compileProvider","DEBUG","$logProvider"],b.$inject=["$rootScope","loginService","$q","$animate"],c.$inject=["$rootScope","dataService","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){var i=this;return a.title="Mantenedor de Artículos",a.subtitle="Lista de atención",a.contador={solicitudes:"-",farmacos:"-",insumos:"-"},a.menu={articulo:""},a.showMenuMobile=!1,a.mostrarMenuMobile=function(){a.showMenuMobile?a.showMenuMobile=!1:a.showMenuMobile=!0},a.cargarIndicadoresIniciales=function(){var b="";null!=a.user.data.AspNetUserId&&(b=a.user.data.AspNetUserId),a.user.permisos.listarSolicitudes&&g.countMSA("","todo","",[2,4,5],b,"MES_ID,VISTO_POR,ASPNET_USER_ID").then(function(b){var c=b.data.filter(function(a){return 4==a.MES_ID&&a.VISTO_POR!=a.ASPNET_USER_ID}),d=b.data.filter(function(a){return 5==a.MES_ID&&a.VISTO_POR!=a.ASPNET_USER_ID}),e=b.data.filter(function(a){return 2==a.MES_ID});a.contador.solicitudes=e.length+c.length+d.length}),a.user.permisos.aprobarSolicitudFarmaco&&g.countMSA("farmaco","todo","",[1,3],"").then(function(b){a.contador.farmacos=b.data.length}),a.user.permisos.aprobarSolicitudInsumo&&g.countMSA("insumo","todo","",[1,3],"").then(function(b){a.contador.insumos=b.data.length})},a.limitarString=function(a,b){return a.length>b?a.substring(0,b)+"...":a},a.getPrimerComentario=function(b,c){if(void 0==b||0==b.length)return"";var d=[],e=b.filter(function(a){return 1==a.ACTIVO&&0==a.ELIMINADO});if(e.length>0&&(d=e),void 0==d||0==d.length)return"";d=a.orderByAttr(d,"FECHA_CREACION","date","desc");var f=d[0].FECHA_CREACION,g=d[0].COMENTARIO,i=c(d[0].ASPNET_USER_ID),j=(g.indexOf("["),g.indexOf("]"));return g=g.substring(j+2),f=h("date")(new Date(f),"yyyy-MM-dd"),"["+f+"] ("+i+")"+g},a.postMessge=function(){c.info("Test","")},a.getNombreServicioSalud=function(b){if(null==a.tiposGlobales.serviciosSalud||0==a.tiposGlobales.serviciosSalud.length)return"";var c=a.tiposGlobales.serviciosSalud.filter(function(a){return a.ID==b});return null!=c&&c.length>0?c[0].RAZON_SOCIAL:""},a.esServicioSalud=function(b){if(null==a.tiposGlobales.serviciosSalud||0==a.tiposGlobales.serviciosSalud.length)return!1;var c=a.tiposGlobales.serviciosSalud.filter(function(a){return a.ID==b});return null!=c&&c.length>0?!0:!1},a.getServicioSalud=function(b){if(null==a.tiposGlobales.serviciosSalud||0==a.tiposGlobales.serviciosSalud.length)return!1;var c=a.tiposGlobales.serviciosSalud.filter(function(a){return a.ID==b});return null!=c&&c.length>0?c[0]:null},a.getNombreReceta=function(b){if(void 0!=a.tiposGlobales.tiposDeReceta){var c=a.tiposGlobales.tiposDeReceta.filter(function(a){return a.ID==b});if(c.length>0)return c[0].DESCRIPCION}return""},a.orderByAttr=function(a,b,c,d){if(!angular.isObject(a))return a;var e=[];for(var f in a)e.push(a[f]);return e.sort(function(a,e){return"int"==c.toLowerCase()?(a=parseInt(a[b]),e=parseInt(e[b]),"asc"==d.toLowerCase()?a-e:e-a):"date"==c.toLowerCase()?(a=a[b],e=e[b],""==a&&(a=-1),""==e&&(e=-1),"asc"==d.toLowerCase()?new Date(a)-new Date(e):new Date(e)-new Date(a)):(a=a[b],e=e[b],"asc"==d.toLowerCase()?a.localeCompare(e):e.localeCompare(a))}),e},a.showModal=function(a){$(a).foundation("reveal","open")},a.closeModal=function(a){$(a).foundation("reveal","close")},a.NeoGrilla=function(a){var b=this;this.active=!1,this.ds=a,this.oculto=!1,this.resultado=[],this.historial=[],this.showHistorial=[],this.nombre="test Grilla",this.waiting=!0,this.sinResultado=!1,this.largo=6,this.mostrando=10,this.paginaActual=1,this.paginacion={labels:[1,2,3,4,5],total:100,mostrar:!1},this.nodoId=null,this.orden="ID",this.ordenDireccion="asc",this.farmaco={clase:"fa fa-check-square-o",toggle:!0},this.insumo={clase:"fa fa-check-square-o",toggle:!0},this.esFarmaciaPopular=!1,this.searchTerms="",this.searchTermsCopy="",this.searchTermsModificado=!1,this.detalle="",this.establecimientoId=void 0,this.callback={getData:null,getCountPaginacion:null},this.finishReload=function(){0==b.resultado.length?(b.sinResultado=!0,b.paginacion.mostrar=!1):(b.sinResultado=!1,b.paginacion.mostrar=!0),b.waiting=!1},this.finishPaginacion=function(a){a.data.length>0?b.paginacion.total=Math.ceil(a.data.length/b.mostrando):b.paginacion.total=1;var c=b.paginacion.total;c>5&&(1==b.paginaActual||2==b.paginaActual)&&(b.paginacion.labels=[1,2,3,4,5]),c>5&&b.paginaActual>2&&(b.paginacion.labels=[b.paginaActual-2,b.paginaActual-1,b.paginaActual,b.paginaActual+1,b.paginaActual+2]),5==c&&(b.paginacion.labels=[1,2,3,4,5]),4==c&&(b.paginacion.labels=[1,2,3,4]),3==c&&(b.paginacion.labels=[1,2,3]),2==c&&(b.paginacion.labels=[1,2]),1==c&&(b.paginacion.labels=[1])},this.reload=function(){this.active&&(this.sinResultado=!1,this.waiting=!0,this.resultado=[],this.obtener="",this.farmaco.toggle&&!this.insumo.toggle&&(this.obtener="farmaco"),!this.farmaco.toggle&&this.insumo.toggle&&(this.obtener="insumo"),null!=this.callback.getData&&this.callback.getData(),null!=this.callback.getCountPaginacion&&this.callback.getCountPaginacion())},this.cambiarContador=function(a){b.mostrando=a,this.paginaActual=1,b.reload()},this.siguientePagina=function(){b.paginaActual+1>b.paginacion.total||(b.paginaActual=b.paginaActual+1,b.paginacion.total>5&&b.paginaActual>3&&(b.paginaActual+2>b.paginacion.total?(b.paginacion.total-b.paginaActual>0&&(b.paginacion.labels=[b.paginaActual-3,b.paginaActual-2,b.paginaActual-1,b.paginaActual,b.paginaActual+1]),b.paginacion.total-b.paginaActual==0&&(b.paginacion.labels=[b.paginaActual-4,b.paginaActual-3,b.paginaActual-2,b.paginaActual-1,b.paginaActual])):b.paginacion.labels=[b.paginaActual-2,b.paginaActual-1,b.paginaActual,b.paginaActual+1,b.paginaActual+2]),b.reload())},this.anteriorPagina=function(){1!=b.paginaActual&&(b.paginaActual=b.paginaActual-1,b.paginacion.total>2&&(b.paginaActual-2<1||b.paginacion.total<5||(b.paginacion.labels=[b.paginaActual-2,b.paginaActual-1,b.paginaActual,b.paginaActual+1,b.paginaActual+2])),b.reload())},this.muestraPagina=function(a){a>b.paginacion.total||1>a||b.paginaActual==a||(b.paginaActual=a,b.reload())},this.sort=function(a,c){b.paginaActual=1,b.orden=a,c&&"asc"==b.ordenDireccion?b.ordenDireccion="desc":b.ordenDireccion="asc",b.reload()},this.pressEnterSearch=function(a){13==a.keyCode&&this.search()},this.search=function(){return this.searchTerms.length<4&&this.searchTerms.length>0?!1:(this.paginaActual=1,void b.reload())},this.searchTermsChange=function(){this.searchTermsModificado=!0},this.doSort=function(a,c){var d=!1;c.target.classList.contains("selected")&&(d=!0),c.target.classList.contains("selected")?c.target.classList.toggle("fa-rotate-180"):($(".grilla thead th i").removeClass("selected"),$(".grilla thead th i").removeClass("fa-rotate-180"),c.target.classList.add("selected")),b.sort(a,d)},this.onError=function(a){"Ha perdido la conexión de red"!=a?(c.error("Hubo un error de conexión, reintentando","Error de Conexión"),this.reload()):(b.finishReload(),c.error("Se ha perdido la conexión, reintente más tarde","Error de Conexión"))}},a.NeoSelect=function(){var b=this;this.nodos=[],this.tiposRecetaTotal=[],this.tiposRecetaFiltrado=[],this.mostrar=!1,this.waiting=!0,this.sinResultado=!1,this.elegido="",this.busqueda="",this.placeholder="",this.callbacks={seleccionado:null},this.seleccionar=function(d){if(b.mostrar=!1,void 0!=b.nodos){var e=b.nodos.filter(function(a){return a.ID==d});if(e.length>0){if(b.elegido=e[0],b.nombreEstablecimiento=e[0].RAZON_SOCIAL,b.searchText=e[0].RAZON_SOCIAL,a.esServicioSalud(e[0].ID))return void c.error("El nodo seleccionado no corresponde a un establecimiento, por favor recarge la página","Error de Selección");if(null!=b.callbacks.seleccionado)return void b.callbacks.seleccionado(d,!0)}}null!=b.callbacks.seleccionado&&b.callbacks.seleccionado(d,!1)},this.getNodo=function(a){},this.desplegar=function(a){b.mostrar=!0},this.cerrar=function(){return null!=event.relatedTarget&&event.relatedTarget.className.includes("nodo-select")?void b.seleccionar(event.relatedTarget.id):(this.mostrar=!1,void(null!=this.elegido?this.searchText=this.elegido.RAZON_SOCIAL:this.searchText=""))},this.revisarWaitingList=function(){var c=!0;for(var d in this.waitingList)if(Array.isArray(this.waitingList[d])&&this.waitingList[d][0]){c=!1;break}this.waitingList2&&(c=!1),c&&(b.nodos=a.eliminarDuplicados(b.nodos,function(a){return a.ID}),b.nodos=a.orderByAttr(b.nodos,"RAZON_SOCIAL","string","asc"),b.waiting=!1,b.sinResultado=!1,b.placeholder="Seleccione el establecimiento a revisar")},this.cargar=function(){var c=[];b.waitingList=[],b.waitingList2=!0;for(var d=0;d<a.user.data.Nodos.length;d++)1!=a.user.data.Nodos[d]&&(a.esServicioSalud(a.user.data.Nodos[d])?(b.waitingList[d]=[!0,a.user.data.Nodos[d]],g.getNodosServiciosSalud(a.user.data.Nodos[d]).then(function(c){for(var d=[],e=c.data,f=0;f<e.length;f++)e[f].RAZON_SOCIAL=e[f].RAZON_SOCIAL+a.getNombreServicioComuna(e[f]),d.push(e[f]);b.nodos=b.nodos.concat(d);for(var g in b.waitingList)if(b.waitingList[g][1]==c.config.input.servicio){b.waitingList[g][0]=!1;break}b.waitingList2=!1,b.revisarWaitingList()})):c.push(a.user.data.Nodos[d]));return 0==a.user.data.Nodos.length?(b.waitingList2=!1,b.waiting=!1,void(b.sinResultado=!0)):(this.sinResultado=!1,void(0!=c.length&&g.getNOD(c).then(function(c){for(var d=c.data,e=[],f=0;f<d.length;f++){var g="";null!=d[f].COM_COMUNA&&(g=" - "+d[f].COM_COMUNA.NOMBRE);var h="";if(null!=d[f].NOD_ID){var i=a.getNombreServicioSalud(d[f].NOD_ID);""!=i&&(h=" - "+i)}d[f].RAZON_SOCIAL=d[f].RAZON_SOCIAL+h+g,e.push(d[f])}b.nodos=b.nodos.concat(e),b.waitingList2=!1,b.revisarWaitingList()})))}},a.getNombreServicioComuna=function(b){var c="";null!=b.COM_COMUNA&&(c=" - "+b.COM_COMUNA.NOMBRE);var d="";if(null!=b.NOD_ID){var e=a.getNombreServicioSalud(b.NOD_ID);""!=e&&(d=" - "+e)}return d+c},a.eliminarDuplicados=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=c.filter(function(c){return b(c)==b(a[d])});0==e.length&&c.push(a[d])}return c},a._toConsumableArray=function(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)},a.joinArrays=function(b,c){var d=a._toConsumableArray(b),e=a._toConsumableArray(c);return[].concat(d,e)},i}angular.module("mantenedorApp").controller("mantenedorController",a),a.$inject=["$rootScope","loginService","toastr","$q","toastrNoDismiss","$log","dataService","$filter"]}(),function(){"use strict";function a(a,b){return{getValidState:function(){return a.CurrentStaffMemberHasPermission(b.LOCATIONS.VIEW_LIST)&&a.memberIsType()?"er.assignment.box":a.CurrentStaffMemberHasPermission(b.PENDING_ORDER.READ_TREATMENT_WORKLIST)&&a.memberIsType()?"er.indications":a.CurrentStaffMemberHasPermission(b.CATEGORIZATION.READ_WORKLIST)&&a.memberIsType()?"er.categorization":a.CurrentStaffMemberHasPermission(b.ADMISSION.READ_PATIENT_LIST)?"er.admission":void a.logout(a.getCurrentStaffMember().Id)}}}angular.module("mantenedorApp").factory("stateService",a),a.$inject=["loginService","PERMISSIONS"]}(),function(){"use strict";function a(a,b){a.state("er.admusuario",{url:"/administracion",views:{"container@":{templateUrl:"administracion/usuario/mantenedor.adm.usuario.view.html",controller:"admUsuarioController as adm"},"infoBarContainer@":{templateUrl:"administracion/usuario/mantenedor.adm.usuario.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.LISTAR_USUARIO,titulo:"Administración de Usuarios"}})}angular.module("mantenedorAdmUsuario",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c){a.showMenuMobile=!1;var d=this;return c.info("Cargando Mantenedor","Administrador de Usuarios"),a.menu={articulo:""},a.title="Mantenedor de Usuarios",d.detalleUsuario={form:{},loading:!1,show:function(){$("#detalleUsuario").foundation("reveal","open")},cerrar:function(){a.closeModal("#detalleUsuario"),this.loading=!1,this.loadingPerfiles=!1},viewUser:function(c){this.form={},this.titulo="Ver Usuario",this.loading=!0,this.form.nodos=[];var e=d.grilla.resultado[c].Nodos.split(",");if(1==e.length&&""==e[0])this.form.nodos=[],this.loading=!1;else{var f=[];this.auxFormNodos=[];for(var g=0;g<e.length;g++)a.esServicioSalud(e[g])?this.auxFormNodos.push(a.getServicioSalud(e[g])):f.push(e[g]);if(f.length>0){var h=this;b.getNOD(f).then(function(b){h.form.nodos=b.data,h.form.nodos=a.joinArrays(h.form.nodos,h.auxFormNodos),h.form.nodos=a.eliminarDuplicados(h.form.nodos,function(a){return a.ID}),h.loading=!1})}else this.form.nodos=this.auxFormNodos,this.loading=!1}this.loadUserData(c),this.loadingPerfiles=!0,this.cargarPermisos(function(){d.detalleUsuario.form.perfiles=d.perfiles;for(var a=0;a<d.detalleUsuario.form.perfiles.length;a++){var b=d.detalleUsuario.form.perfiles[a].Id;d.detalleUsuario.form.perfiles[a].checked=!1;for(var e=0;e<d.grilla.resultado[c].Roles.length;e++)b==d.grilla.resultado[c].Roles[e].RoleId&&(d.detalleUsuario.form.perfiles[a].checked=!0)}d.detalleUsuario.loadingPerfiles=!1}),this.show(c)},loadUserData:function(a){var b=d.grilla.resultado[a];this.form.nombre=b.FullName,this.form.rut=b.Rut,this.form.correo=b.Email;var c=[];""!=b.Restricciones&&(c=b.Restricciones.split(",")),this.form.permisosExcluidos=null!=b.Restricciones?d.eliminarPermisosDuplicados(c):[],this.form.permisosExcluidos.sort(),c=[],""!=b.Permisos&&(c=b.Permisos.split(",")),this.form.permisosIncluidos=null!=b.Permisos?d.eliminarPermisosDuplicados(c):[],this.form.permisosIncluidos.sort()},cargarPermisos:function(a){b.getListaROLES().then(function(c){return d.perfiles=c.data,b.getRolesPermisos().then(function(b){for(var c=0;c<d.perfiles.length;c++){var e=b.data.filter(function(a){return a.ID==d.perfiles[c].Id});if(d.perfiles[c].Permisos=[],e.length>0)for(var f=0;f<e.length;f++)d.perfiles[c].Permisos.push(e[f].PERMISO)}a()})})}},d.establecimientos={servicios:[{ID:-1,DESCRIPCION:"Seleccionar Servicio de Salud"},{ID:0,DESCRIPCION:"Todos"}].concat(a.tiposGlobales.serviciosSalud),init:function(){for(var a=0;a<this.servicios.length;a++)this.servicios[a].ID>0&&(this.servicios[a].comunas=null,this.servicios[a].nodos=null)},getComunas:function(a,c){var d=this.servicios.filter(function(b){return b.ID==a});return d.length<1?[]:void(null!=d[0].comunas?c(d[0].comunas):b.getNodosServiciosSalud(a).then(function(a){for(var b=[],e=[],f=0;f<a.data.length;f++)null!=a.data[f].COM_COMUNA&&-1==b.indexOf(a.data[f].COM_COMUNA.NOMBRE)&&(b.push(a.data[f].COM_COMUNA.NOMBRE),e.push({value:a.data[f].COM_COMUNA.ID,name:a.data[f].COM_COMUNA.NOMBRE}));d[0].comunas=e,c(d[0].comunas)}))},getEstablecimientos:function(a,c,d){var e=this.servicios.filter(function(b){return b.ID==a});return e.length<1?[]:void(null!=e[0].nodos?d(e[0].nodos[c]):b.getNodosServiciosSalud(a).then(function(a){for(var b=[],f=0;f<a.data.length;f++)null!=a.data[f].COM_COMUNA&&(a.data[f].COM_COMUNA.ID in b||(b[a.data[f].COM_COMUNA.ID]=[]),b[a.data[f].COM_COMUNA.ID].push({value:a.data[f].ID,name:a.data[f].DESCRIPCION}));e[0].nodos=b,d(e[0].nodos[c])}))}},d.establecimientos.init(),d.editarUsuario={procesando:!1,textoProcesando:"",detalle:{procesando:!1},show:function(){$("#editarUsuario").foundation("reveal","open")},cerrar:function(){a.closeModal("#detalleUsuario"),this.loading={perfiles:!1,nodos:!1}},reset:function(){this.loading={perfiles:!1,nodos:!1,comunas:!1},this.bag={},this.validacion={procesando:!1,resultado:!1,rut:!1},this.select={excluirPermiso:[],incluirPermiso:[],nodos:[]},this.porDefecto={servicioSalud:{ID:-1,DESCRIPCION:"Seleccionar Servicio de Salud"},comuna:{COM_COMUNA:{ID:-1,NOMBRE:"Todas las comunas"}},nodo:"Todos los nodos"},this.listas={servicios:[{ID:-1,DESCRIPCION:"Seleccionar Servicio de Salud"},{ID:0,DESCRIPCION:"Todos"}].concat(a.tiposGlobales.serviciosSalud),comunas:[],nodos:[]},this.form={clave:"",repitaClave:"",servicio:this.porDefecto.servicioSalud,comuna:null,nodo:null,permisosIncluidos:[],permisosExcluidos:[],nodos:[]},this.requerido={nombre:!1,rut:!1,rutDuplicado:!1,rutInvalido:!1,correo:!1,correoDuplicado:!1,perfiles:!1,claveDistinta:!1,claveFormato:!1,nodos:!1},this.procesando=!1},validar:function(a){var b=!0;if(this.requerido={nombre:!1,rut:!1,rutDuplicado:!1,rutInvalido:!1,correo:!1,correoDuplicado:!1,perfiles:!1,claveDistinta:!1,claveFormato:!1,nodos:!1},""==this.form.nombre&&(this.requerido.nombre=!0,b=!1),""==this.form.correo&&(this.requerido.correo=!0,b=!1),d.validarRut(this.form.rut)||(this.requerido.rutInvalido=!0,b=!1),a||""!=this.form.clave||""!=this.form.repitaClave){(""==this.form.clave||""==this.form.repitaClave)&&(this.requerido.clave=!0,b=!1),this.form.clave!=this.form.repitaClave&&(this.requerido.claveDistinta=!0,b=!1);var c=new RegExp("^(?=.*[A-Z].*[A-Z])(?=.*[!@#$[^&*])(?=.*[0-9].*[0-9])(?=.*[a-z].*[a-z]).{8,16}$");c.test(this.form.clave)||(this.requerido.claveFormato=!0,b=!1)}this.requerido.perfiles=!0;for(var e=!1,f=0;f<this.form.perfiles.length;f++)this.form.perfiles[f].checked&&(this.requerido.perfiles=!1,e=!0);return e||(b=!1),b},validarFormatoRut:function(){this.requerido.rutInvalido=!1,this.requerido.rutDuplicado=!1,d.validarRut(this.form.rut)||(this.requerido.rutInvalido=!0)},validarRut:function(a){b.getAccountRut(this.form.rut).then(function(b){return b.data.length>0?(d.editarUsuario.requerido.rutDuplicado=!0,void(null!=a&&a(!1))):void(null!=a&&a(!0))})},validarCorreo:function(a){b.getAccountCorreo(this.form.correo).then(function(b){return b.data.length>0?(d.editarUsuario.requerido.correoDuplicado=!0,void(null!=a&&a(!1))):void(null!=a&&a(!0))})},revisarWaitingList:function(){for(var a=!0,b=0;b<this.bag.waitingList.length;b++)this.bag.waitingList[b]&&(a=!1);a&&(this.bag.waitingError?this.esEdicion?c.warning("Usuario actualizado con error en la asignación de perfiles, por favor revise","Edición de Usuario"):c.warning("Usuario creado con error en la asignación de los perfiles, por favor valide","Edición de Usuario"):this.esEdicion?c.success("Usuario actualizado","Edición de Usuario"):c.success("Usuario creado con éxito","Edición de Usuario"),this.procesando=!1,d.grilla.reload(),this.cerrar())},revisarWaitingCreacion:function(){this.bag.waitingCreacion.rut||this.bag.waitingCreacion.correo||this.procesando&&this.crear()},preCrear:function(){return this.procesando=!0,this.textoProcesando="Validando",this.bag.waitingCreacion={rut:!0,correo:!0},this.validar(!0)?(this.validarRut(function(a){return a?(d.editarUsuario.bag.waitingCreacion.rut=!1,void d.editarUsuario.revisarWaitingCreacion()):(c.warning("El rut indicado ya existe en el sistema","Edición de Usuario"),void(d.editarUsuario.procesando=!1))}),void this.validarCorreo(function(a){return a?(d.editarUsuario.bag.waitingCreacion.correo=!1,void d.editarUsuario.revisarWaitingCreacion()):(c.warning("El correo indicado ya existe en el sistema","Edición de Usuario"),void(d.editarUsuario.procesando=!1))})):(c.error("Existen errores en el formulario","Edición de Usuario"),this.procesando=!1,!1)},crear:function(){var e={};e.permisos=this.form.permisosIncluidos.join(),e.restricciones=this.form.permisosExcluidos.join();var f=[];if(this.form.servicio.ID>-1)if(0==this.form.servicio.ID)for(var g=0;g<a.tiposGlobales.serviciosSalud.length;g++)f.push(a.tiposGlobales.serviciosSalud[g].ID);else 0==this.form.comuna.value?f.push(this.form.servicio.ID):0==this.form.establecimiento.value?d.establecimientos.getEstablecimientos(this.form.servicio.ID,this.form.comuna.value,function(a){for(var b=0;b<a.length;b++)f.push(a[b].value)}):f.push(this.form.establecimiento.value);for(var g=0;g<d.editarUsuario.form.nodos.length;g++)f.push(d.editarUsuario.form.nodos[g].id);f=a.eliminarDuplicados(f,function(a){return a}),e.nodos=f.join();var h=!1;if(this.form.perfiles.filter(function(a){return"Administrador"==a.Name&&a.checked}).length>0&&(h=!0),""==e.nodos&&!h)return this.requerido.nodos=!0,this.procesando=!1,void c.warning("Existen errores en el formulario, revise por favor","Edición de Usuario");this.textoProcesando="Creando usuario...",e.rut=d.formatoGuardado(this.form.rut),e.nombre=this.form.nombre,e.correo=this.form.correo,e.perfiles="",e.stamp=d.randomString(40),e.clave=this.form.clave;b.postUSER(e).then(function(a){var e=a.data,f=d.editarUsuario.form.perfiles.filter(function(a){return a.checked});if(0==f.length)return d.editarUsuario.procesando=!1,d.grilla.reload(),d.editarUsuario.cerrar(),void c.success("Usuario creado correctamente","Edición de Usuario");d.editarUsuario.bag.waitingList=[];for(var g=0;g<f.length;g++)d.editarUsuario.bag.waitingList[g]=!0;d.editarUsuario.bag.waitingError=!1;for(var g=0;g<f.length;g++)f[g].checked?b.putUserPerfil(e.Id,f[g].Id,g).then(function(a){d.editarUsuario.bag.waitingList[a.config.input.position]=!1,d.editarUsuario.revisarWaitingList()})["catch"](function(a){d.editarUsuario.bag.waitingList[a.config.input.position]=!1,d.editarUsuario.bag.waitingError=!0,d.editarUsuario.revisarWaitingList()}):(d.editarUsuario.bag.waitingList[g]=!1,d.editarUsuario.revisarWaitingList())})["catch"](function(a){d.editarUsuario.procesando=!1,c.error("Ocurrió un error al crear el usuario","Edición de Usuario")})},revisarWaitingPerfil:function(){for(var a=!0,b=0;b<this.bag.waitingPerfilList.length;b++)this.bag.waitingPerfilList[b]&&(a=!1);a&&(this.bag.waitingError?c.warning("Perfiles actualizados con error, por favor revise","Edición de Usuario"):c.success("Perfiles actualizados con éxito","Edición de Usuario"))},guardar:function(){return this.procesando=!0,this.textoProcesando="Validando",this.validar(!1)?void(this.form.correo!=this.usuario.Email?(this.textoProcesando="Validando correo...",this.validarCorreo(function(a){return a?void d.editarUsuario.guardarPaso2():(c.warning("El correo asignado ya existe en el sistema, revise por favor","Error"),void(d.editarUsuario.procesando=!1))})):this.guardarPaso2()):(c.warning("Existen errores en el formulario","Edición de Usuario"),this.procesando=!1,!1)},guardarPaso2:function(){this.bag.waitingPerfilList=[];for(var e=0;e<this.form.perfiles.length;e++)this.bag.waitingPerfilList[e]=!0;for(var e=0;e<this.form.perfiles.length;e++)this.form.perfiles[e].checked?b.putUserPerfil(d.editarUsuario.usuario.Id,d.editarUsuario.form.perfiles[e].Id,e).then(function(a){d.editarUsuario.bag.waitingPerfilList[a.config.input.position]=!1,d.editarUsuario.revisarWaitingPerfil()})["catch"](function(a){d.editarUsuario.procesando=!1,d.editarUsuario.bag.waitingPerfilList[a.config.input.position]=!1,d.editarUsuario.revisarWaitingPerfil()}):b.deleteUserPerfil(d.editarUsuario.usuario.Id,d.editarUsuario.form.perfiles[e].Id,e).then(function(a){d.editarUsuario.bag.waitingPerfilList[a.config.input.position]=!1,d.editarUsuario.revisarWaitingPerfil()})["catch"](function(a){d.editarUsuario.procesando=!1,d.editarUsuario.bag.waitingPerfilList[a.config.input.position]=!1,d.editarUsuario.revisarWaitingPerfil()});this.textoProcesando="Validando permisos...",this.usuario.Permisos=this.form.permisosIncluidos.join(),this.usuario.Restricciones=this.form.permisosExcluidos.join();var f=[];if(null!=this.form.servicio&&this.form.servicio.ID>-1)if(0==this.form.servicio.ID)for(var e=0;e<a.tiposGlobales.serviciosSalud.length;e++)f.push(a.tiposGlobales.serviciosSalud[e].ID);else 0==this.form.comuna.value?f.push(this.form.servicio.ID):0==this.form.establecimiento.value?d.establecimientos.getEstablecimientos(this.form.servicio.ID,this.form.comuna.value,function(a){for(var b=0;b<a.length;b++)f.push(a[b].value)}):f.push(this.form.establecimiento.value);for(var e=0;e<this.form.nodos.length;e++)f.push(this.form.nodos[e].ID);f=a.eliminarDuplicados(f,function(a){return a}),this.usuario.Nodos=f.join(),this.usuario.FullName=this.form.nombre,this.usuario.Email=this.form.correo,this.textoProcesando="Actualizando datos del usuario...",b.putUSER(this.usuario).then(function(a){return""==d.editarUsuario.form.clave&&""==d.editarUsuario.form.repitaClave?(d.grilla.reload(),d.editarUsuario.cerrar(),void c.success("Usuario fue actualizado con éxito","Edición de Usuario")):(d.editarUsuario.textoProcesando="Actualizando clave",void b.putUserPassword(d.editarUsuario.usuario.Id,d.editarUsuario.form.clave).then(function(a){d.editarUsuario.cerrar(),c.success("Usuario fue actualizado con éxito","Edición de Usuario")})["catch"](function(a){d.editarUsuario.procesando=!1,c.error("Ocurrió un error al actualizar la clave","Edición de Usuario")}))})["catch"](function(a){d.editarUsuario.procesando=!1,c.error("Ocurrió un error al actualizar el usuario","Edición de Usuario")})},nuevo:function(){this.reset(),this.titulo="Crear Usuario",this.esEdicion=!1,this.loading.perfiles=!0,this.usuario=null,this.cargarPermisos(function(){var b=d.perfiles;d.editarUsuario.form.perfiles=d.perfiles;for(var c=[],e=[],f=0;f<b.length;f++){b[f].Id;b[f].checked=!1,b[f].checked||(e=a.joinArrays(e,b[f].Permisos))}c=d.eliminarPermisosDuplicados(c),e=d.eliminarPermisosDuplicados(e),d.editarUsuario.permisos={excluir:c,incluir:e,backEx:c,backIn:e},d.editarUsuario.loading.perfiles=!1}),this.show()},editar:function(b){this.reset(),this.esEdicion=!0,this.loading.perfiles=!0,this.loading.nodos=!0,this.titulo="Editar Usuario",this.index=b,this.loadUserData(),this.cargarPermisos(function(){var b=d.editarUsuario.original,c=d.perfiles;d.editarUsuario.form.perfiles=d.perfiles;for(var e=[],f=[],g=0;g<c.length;g++){var h=c[g].Id;c[g].checked=!1;for(var i=0;i<b.Roles.length;i++)if(h==b.Roles[i].RoleId){c[g].checked=!0;for(var j=0;j<c[g].Permisos.length;j++)e=a.joinArrays(e,c[g].Permisos)}c[g].checked||(f=a.joinArrays(f,c[g].Permisos))}e=d.eliminarPermisosDuplicados(e),f=d.eliminarPermisosDuplicados(f);for(var i=0;i<d.editarUsuario.form.permisosExcluidos.length;i++)e.splice(e.indexOf(d.editarUsuario.form.permisosExcluidos),1);for(var i=0;i<d.editarUsuario.form.permisosIncluidos.length;i++)f.splice(f.indexOf(d.editarUsuario.form.permisosIncluidos[i]),1);e.sort(),f.sort(),d.editarUsuario.permisos={excluir:e,incluir:f,backEx:e,backIn:f},d.editarUsuario.loading.perfiles=!1}),d.editarUsuario.show()},loadUserData:function(){var c=d.grilla.resultado[this.index],e=d.grilla.resultado[this.index].Nodos.split(",");if(1==e.length&&""==e[0])this.form.nodos=[],this.loading.nodos=!1;else{e=a.eliminarDuplicados(e,function(a){return a});var f=[];this.auxFormNodos=[];for(var g=0;g<e.length;g++)a.esServicioSalud(e[g])?this.auxFormNodos.push(a.getServicioSalud(e[g])):f.push(e[g]);f.length>0?b.getNOD(f).then(function(b){d.editarUsuario.form.nodos=b.data,
d.editarUsuario.form.nodos=a.joinArrays(d.editarUsuario.form.nodos,d.editarUsuario.auxFormNodos),d.editarUsuario.loading.nodos=!1}):(this.form.nodos=this.auxFormNodos,this.loading.nodos=!1)}this.usuario=angular.copy(d.grilla.resultado[this.index]),this.original=c,this.form.nombre=c.FullName,this.form.rut=c.Rut,this.form.correo=c.Email,this.form.perfiles=d.perfiles,this.form.permisosExcluidos=null!=c.Restricciones&&""!=c.Restricciones?d.eliminarPermisosDuplicados(c.Restricciones.split(",")):[],this.form.permisosIncluidos=null!=c.Permisos&&""!=c.Permisos?d.eliminarPermisosDuplicados(c.Permisos.split(",")):[],this.form.permisosExcluidos.sort(),this.form.permisosIncluidos.sort()},seleccionarServicio:function(){this.loading.comunas=!0,this.listas.comunas=[],this.listas.nodos=[],this.form.servicio.ID>1?d.establecimientos.getComunas(this.form.servicio.ID,function(a){d.editarUsuario.listas.comunas=[{value:0,name:"Todas las comunas"}].concat(a),d.editarUsuario.form.comuna={value:0,name:"Todas las comunas"},d.editarUsuario.loading.comunas=!1}):this.loading.comunas=!1},seleccionarComuna:function(){0!=this.listas.comunas.length&&(this.loading.establecimientos=!0,this.listas.nodos=[],this.form.comuna.value>0?d.establecimientos.getEstablecimientos(this.form.servicio.ID,this.form.comuna.value,function(a){d.editarUsuario.listas.nodos=[{value:0,name:"Todos los establecimientos"}].concat(a),d.editarUsuario.form.establecimiento={value:0,name:"Todos los establecimientos"},d.editarUsuario.loading.establecimientos=!1}):this.loading.establecimientos=!1)},quitarNodo:function(a){this.procesando||this.form.nodos.splice(this.form.nodos.indexOf(a),1)},cargarPermisos:function(a){b.getListaROLES().then(function(c){return d.perfiles=c.data,b.getRolesPermisos().then(function(b){for(var c=0;c<d.perfiles.length;c++){var e=b.data.filter(function(a){return a.ID==d.perfiles[c].Id});if(d.perfiles[c].Permisos=[],e.length>0)for(var f=0;f<e.length;f++)d.perfiles[c].Permisos.push(e[f].PERMISO)}a()})})},excluirPermiso:function(){this.procesando||null==this.select.excluirPermiso||(this.form.permisosExcluidos.push(this.select.excluirPermiso),this.form.permisosExcluidos=d.eliminarPermisosDuplicados(this.form.permisosExcluidos),this.form.permisosExcluidos.sort(),this.permisos.excluir=d.eliminarPermisosDuplicados(this.permisos.excluir),this.permisos.excluir.splice(this.permisos.excluir.indexOf(this.select.excluirPermiso),1),this.select.excluirPermiso=null,this.form.permisosIncluidos.splice(this.permisos.incluir.indexOf(this.select.excluirPermiso),1))},quitarExclusion:function(a){this.procesando||(this.form.permisosExcluidos.splice(this.form.permisosExcluidos.indexOf(a),1),-1!=this.permisos.backEx.indexOf(a)&&(this.permisos.excluir.push(a),this.permisos.excluir=d.eliminarPermisosDuplicados(this.permisos.excluir),this.permisos.excluir.sort()))},incluirPermiso:function(){this.procesando||null==this.select.incluirPermiso||(this.form.permisosIncluidos.push(this.select.incluirPermiso),this.form.permisosIncluidos=d.eliminarPermisosDuplicados(this.form.permisosIncluidos),this.form.permisosIncluidos.sort(),this.permisos.incluir=d.eliminarPermisosDuplicados(this.permisos.incluir),this.permisos.incluir.splice(this.permisos.incluir.indexOf(this.select.incluirPermiso),1),this.select.incluirPermiso=null)},quitarInclusion:function(a){this.procesando||(this.form.permisosIncluidos.splice(this.form.permisosIncluidos.indexOf(a),1),-1!=this.permisos.backIn.indexOf(a)&&(this.permisos.incluir.push(a),this.permisos.incluir=d.eliminarPermisosDuplicados(this.permisos.incluir),this.permisos.incluir.sort()))},recargarPermisosIndividuales:function(){for(var b=(d.editarUsuario.original,d.editarUsuario.form.perfiles),c=[],e=[],f=0;f<b.length;f++){b[f].Id;1==b[f].checked?c=a.joinArrays(c,b[f].Permisos):e=a.joinArrays(e,b[f].Permisos)}c=d.eliminarPermisosDuplicados(c),e=d.eliminarPermisosDuplicados(e);for(var g=0;g<c.length;g++)e.splice(e.indexOf(c[g]),1);d.editarUsuario.permisos.backEx=angular.copy(c),d.editarUsuario.permisos.backIn=angular.copy(e);for(var g=0;g<d.editarUsuario.form.permisosIncluidos.length;g++)e.splice(e.indexOf(d.editarUsuario.form.permisosIncluidos[g]),1);for(var g=0;g<d.editarUsuario.form.permisosExcluidos.length;g++)c.splice(c.indexOf(d.editarUsuario.form.permisosExcluidos[g]),1);c.sort(),e.sort(),d.editarUsuario.permisos.excluir=c,d.editarUsuario.permisos.incluir=e}},d.modalDesactivacion={estados:[{value:!0,name:"ACTIVO"},{value:!1,name:"INACTIVO"}],objeto:null,value:null,accion:"",proceando:!1,show:function(a,b){this.procesando=!1,this.objeto=a,this.accion="activar",b&&(this.accion="desactivar"),$("#confirmaDesactivacion").foundation("reveal","open")},cerrar:function(){this.objeto.formActivo=this.objeto.Locked,$("#confirmaDesactivacion").foundation("reveal","close"),this.objeto=null},confirmar:function(){this.procesando=!0,this.objeto.Locked=!0,"activar"==this.accion&&(this.objeto.Locked=!1),b.putUSER(this.objeto).then(function(a){d.editarUsuario.cerrar(),c.info("Usuario fue actualizado con éxito","Éxito"),d.grilla.reload()})["catch"](function(a){c.error("Ocurrió un error al actualizar el usuario","Éxito")})}},d.eliminarDuplicados=function(a){for(var b=[],c=0;c<a.length;c++){var d=b.filter(function(b){return b.COM_COMUNA.ID==a[c].COM_COMUNA.ID});0==d.length&&b.push(a[c])}return b},d.eliminarPermisosDuplicados=function(a){for(var b=[],c=0;c<a.length;c++){var d=b.filter(function(b){return b==a[c]});0==d.length&&b.push(a[c])}return b},b.getListaROLES().then(function(a){return d.perfiles=a.data,b.getRolesPermisos().then(function(a){for(var b=0;b<d.perfiles.length;b++){var c=a.data.filter(function(a){return a.ID==d.perfiles[b].Id});if(d.perfiles[b].Permisos=[],c.length>0)for(var e=0;e<c.length;e++)d.perfiles[b].Permisos.push(c[e].PERMISO)}})}),d.grilla=new a.NeoGrilla(b),d.grilla.largo=5,d.grilla.waiting=!0,d.grilla.active=!0,d.grilla.usuariosActivos="activo",d.grilla.farmaco.toggle=!1,d.grilla.farmaco.clase="fa fa-square-o",d.grilla.orden="FullName",d.grilla.callback.getData=function(){d.grilla.ds.getACCOUNT(d.grilla.usuariosActivos,d.grilla.mostrando,d.grilla.paginaActual,d.grilla.orden,d.grilla.ordenDireccion,d.grilla.searchTerms.length>3?d.grilla.searchTerms:"").then(function(a){for(var b=0;b<a.data.length;b++)null==a.data[b].Nodos&&(a.data[b].Nodos=""),null==a.data[b].Permisos&&(a.data[b].Permisos=""),null==a.data[b].Restricciones&&(a.data[b].Restricciones="");a.data.forEach(function(a){return a.Locked==(null==a.Locked)?!1:a.Locked}),d.grilla.resultado=a.data,d.grilla.finishReload()})},d.grilla.callback.getCountPaginacion=function(){d.grilla.ds.countACCOUNT(d.grilla.usuariosActivos,d.grilla.mostrando,d.grilla.paginaActual,d.grilla.searchTerms.length>3?d.grilla.searchTerms:"").then(function(a){d.grilla.finishPaginacion(a)})},d.grilla.reload(),d.toggleFarmaco=function(){d.grilla.waiting||(d.grilla.farmaco.toggle?(d.grilla.usuariosActivos="activo",d.grilla.farmaco.toggle=!1,d.grilla.farmaco.clase="fa fa-square-o"):(d.grilla.usuariosActivos="inactivo",d.grilla.farmaco.toggle=!0,d.grilla.farmaco.clase="fa fa-check-square-o"),d.grilla.reload())},d.sortEstado=function(a){d.doSort("Locked",a)},d.sortCorreo=function(a){d.doSort("Email",a)},d.sortNombre=function(a){d.doSort("FullName",a)},d.sortRut=function(a){d.doSort("Rut",a)},d.doSort=function(a,b){var c=!1;b.target.classList.contains("selected")&&(c=!0),b.target.classList.contains("selected")?b.target.classList.toggle("fa-rotate-180"):($(".grilla thead th i").removeClass("selected"),$(".grilla thead th i").removeClass("fa-rotate-180"),b.target.classList.add("selected")),d.grilla.sort(a,c)},d.validarRut=function(a){a=d.quitarFormato(a);var b=a.length;if(2>b)return!1;for(var c=0;b>c;c++)if(!d.digitoValido(a.charAt(c)))return!1;for(var e="",c=b-1,f=0;c>=0;c--,f++)e+=a.charAt(c);var g="";g+=e.charAt(0),g+="-";for(var h=0,c=1,f=2;b>c;c++,f++)3==h?(g+=".",f++,g+=e.charAt(c),h=1):(g+=e.charAt(c),h++);e="";for(var c=g.length-1,f=0;c>=0;c--,f++)e+=g.charAt(c);return d.digitoCorrecto(a)?!0:!1},d.quitarFormato=function(a){for(var b=new String(a);-1!=b.indexOf(".");)b=b.replace(".","");for(;-1!=b.indexOf("-");)b=b.replace("-","");return b},d.formatoGuardado=function(a){for(var b=new String(a);-1!=b.indexOf(".");)b=b.replace(".","");return b},d.digitoValido=function(a){return"0"!=a&&"1"!=a&&"2"!=a&&"3"!=a&&"4"!=a&&"5"!=a&&"6"!=a&&"7"!=a&&"8"!=a&&"9"!=a&&"k"!=a&&"K"!=a?!1:!0},d.digitoCorrecto=function(a){var b=a.length;if(2>b)return!1;var c=null;c=b>2?a.substring(0,b-1):a.charAt(0);var e=a.charAt(b-1);if(d.digitoValido(e),null==c||null==e)return 0;var f=d.getDigito(c);return f!=e.toLowerCase()?!1:!0},d.getDigito=function(a){for(var b=0,c=2,d=a.length-1;d>=0;d--)b+=a.charAt(d)*c,7==c?c=2:c++;var e=b%11;return 1==e?"k":0==e?"0":11-e},d.randomString=function(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b},d}angular.module("mantenedorAdmUsuario").controller("admUsuarioController",a),a.$inject=["$rootScope","dataService","toastr"]}(),function(){"use strict";function a(a,b){a.state("er.admperfil",{url:"/administracion/perfil",views:{"container@":{templateUrl:"administracion/perfil/mantenedor.adm.perfil.view.html",controller:"admPerfilController as adm"},"infoBarContainer@":{templateUrl:"administracion/perfil/mantenedor.adm.perfil.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.LISTAR_PERFIL,titulo:"Administración de Perfiles"}})}angular.module("mantenedorAdmPerfil",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;c.info("Cargando Mantenedor","Administrador de Perfiles"),a.menu={articulo:""},a.title="Mantenedor de Perfiles",e.permisos=[];for(var f in d.MANTENEDOR)d.MANTENEDOR.hasOwnProperty(f)&&e.permisos.push(d.MANTENEDOR[f]);return e.detallePerfil={form:{},detalle:{procesando:!1},show:function(){$("#detallePerfil").foundation("reveal","open")},cerrar:function(){a.closeModal("#detallePerfil"),this.detalle.procesando=!1},view:function(a){this.form={},this.titulo="Ver Perfil",this.detalle.procesando=!0,this.loadData(a),this.show(a)},loadData:function(a){var b=e.grilla.resultado[a];this.form.nombre=b.Name,this.form.permisosIncluidos=null!=b.Permisos?e.eliminarPermisosDuplicados(b.Permisos):[]}},e.editarPerfil={procesando:!1,textoProcesando:"",form:{},detalle:{procesando:!1},requerido:{},select:{excluirPermiso:"",incluirPermiso:""},show:function(){$("#editarPerfil").foundation("reveal","open")},cerrar:function(){a.closeModal("#detallePerfil"),this.detalle.procesando=!1},validar:function(){var a=!0;return""==this.form.nombre&&(this.requerido.nombre=!0,a=!1),0==this.form.permisosIncluidos.length&&(this.requerido.permiso=!0,a=!1),a},finalizarGuardadoPermisos:function(a){this.textoProcesando="Actualizando permisos...",this.esEdicion||(this.textoProcesando="Asignando permisos..."),this.waitingList=[];for(var c=0;c<e.permisos.length;c++)this.waitingList[c]=!0;this.waitingError=!1;for(var c=0;c<e.permisos.length;c++)-1==this.form.permisosIncluidos.indexOf(e.permisos[c])?this.esEdicion?b.deleteRolesPermisos(a,e.permisos[c],c).then(function(a){e.editarPerfil.waitingList[a.config.input.position]=!1,e.editarPerfil.revisarWaitingList()})["catch"](function(a){e.editarPerfil.waitingList[a.config.input.position]=!1,e.editarPerfil.waitingError=!0,e.editarPerfil.revisarWaitingList()}):(this.waitingList[c]=!1,this.revisarWaitingList()):b.putRolesPermisos(a,e.permisos[c],c).then(function(a){e.editarPerfil.waitingList[a.config.input.position]=!1,e.editarPerfil.revisarWaitingList()})["catch"](function(a){e.editarPerfil.waitingList[a.config.input.position]=!1,e.editarPerfil.revisarWaitingList()})},guardar:function(){return this.procesando?void 0:(this.procesando=!0,this.textoProcesando="Validando...",this.validar()?void b.getROLES(1,1,this.form.nombre,"").then(function(a){return a.data.length>0&&a.data[0].Id!=e.editarPerfil.perfil.Id?(c.warning("Ya existe un perfil con el nombre indicado","Edición de Perfil"),e.editarPerfil.requerido.nombreUnico=!0,e.editarPerfil.procesando=!1,!1):void(e.editarPerfil.esEdicion?(e.editarPerfil.perfil.Name=e.editarPerfil.form.nombre,b.putRole(e.editarPerfil.perfil).then(function(a){e.editarPerfil.finalizarGuardadoPermisos(e.editarPerfil.perfil.Id)})["catch"](function(a){e.editarPerfil.procesando=!1,e.grilla.reload(),c.error("Ocurrió un error al modificar el perfil","Edición de Perfil")})):b.postRole(e.editarPerfil.form.nombre).then(function(a){e.editarPerfil.finalizarGuardadoPermisos(a.data.Id)})["catch"](function(a){e.editarPerfil.procesando=!1,e.grilla.reload(),c.error("Ocurrió un error al crear el perfil","Edición de Perfil")}))}):(c.warning("Existen errores en el formulario","Edición de Perfil"),this.procesando=!1,!1))},init:function(){this.form={nombre:"",permisosIncluidos:[]},this.requerido={nombre:!1,nombreUnico:!1,perfiles:!1,permiso:!1},this.procesando=!1},crear:function(){this.init(),this.titulo="Nuevo Perfil",this.esEdicion=!1;var a=angular.copy(e.permisos);a.sort(),this.permisos={incluir:a},this.show()},edit:function(b){this.init(),this.esEdicion=!0,this.titulo="Editar Perfil",this.loadData(b);var c=[];c=a.joinArrays(c,e.permisos),c=e.eliminarPermisosDuplicados(c);for(var d=0;d<this.original.Permisos.length;d++)c.splice(c.indexOf(this.original.Permisos[d].PERMISO),1);c.sort(),this.permisos={incluir:c},this.show()},loadData:function(a){var b=e.grilla.resultado[a];this.perfil=angular.copy(e.grilla.resultado[a]),this.original=e.grilla.resultado[a],this.form.nombre=this.perfil.Name,this.form.permisosIncluidos=[];for(var c=0;c<b.Permisos.length>0;c++)this.form.permisosIncluidos.push(b.Permisos[c].PERMISO);this.form.permisosIncluidos.sort()},incluirPermiso:function(){null!=this.select.incluirPermiso&&(this.form.permisosIncluidos.push(this.select.incluirPermiso),this.form.permisosIncluidos.sort(),this.permisos.incluir.splice(this.permisos.incluir.indexOf(this.select.incluirPermiso),1),this.select.incluirPermiso=null)},quitarInclusion:function(a){this.procesando||(this.form.permisosIncluidos.splice(this.form.permisosIncluidos.indexOf(a),1),this.permisos.incluir.push(a),this.permisos.incluir.sort())},revisarWaitingList:function(){for(var a=!0,b=0;b<this.waitingList.length;b++)this.waitingList[b]&&(a=!1);a&&(this.waitingError?this.esEdicion?c.warning("Se produjeron problemas al actualizar el perfil, por favor revise","Edición de Perfil"):c.warning("Se produjeron problemas al crear el perfil, por favor revise","Edición de Perfil"):this.esEdicion?c.success("Perfil actualizado","Edición de Perfil"):c.success("Perfil creado","Edición de Perfil"),this.procesando=!1,e.grilla.reload(),this.cerrar())}},e.modalEliminacion={objeto:null,value:null,accion:"",procesando:!1,show:function(a){this.objeto=a,$("#confirmaEliminacion").foundation("reveal","open")},cerrar:function(){return this.procesando?!1:($("#confirmaEliminacion").foundation("reveal","close"),void(this.objeto=null))},confirmar:function(){return this.procesando?!1:(this.procesando=!0,void b.isEmptyRole(this.objeto.Id).then(function(a){if(a.data){if(e.modalEliminacion.waitingList=[],e.modalEliminacion.waitingError=!1,0==e.modalEliminacion.objeto.Permisos.length)return e.modalEliminacion.revisarWaitingList();for(var d=0;d<e.modalEliminacion.objeto.Permisos.length;d++)e.modalEliminacion.waitingList[d]=!0;for(var d=0;d<e.modalEliminacion.objeto.Permisos.length;d++)b.deleteRolesPermisos(e.modalEliminacion.objeto.Permisos[d].ID,e.modalEliminacion.objeto.Permisos[d].PERMISO,d).then(function(a){e.modalEliminacion.waitingList[a.config.input.position]=!1,e.modalEliminacion.revisarWaitingList()})["catch"](function(a){c.error("No se encuentra autorizado para realizar la acción","Problema")})}else e.modalEliminacion.procesando=!1,c.error("No se puede eliminar un perfil con usuarios asignados","Problema")})["catch"](function(a){e.modalEliminacion.procesando=!1,e.grilla.reload(),e.modalEliminacion.cerrar(),c.error("No se pudo validar la cantidad de usuarios del perfil","Problema")}))},revisarWaitingList:function(){for(var a=!0,d=0;d<this.waitingList.length;d++)this.waitingList[d]&&(a=!1);a&&(this.waitingError?c.error("No se pudieron eliminar los permisos asociados al perfil, por favor revise","Edición de Perfil"):b.deleteRole(this.objeto.Id).then(function(a){e.modalEliminacion.procesando=!1,e.grilla.reload(),e.modalEliminacion.cerrar(),c.success("Perfil eliminado con éxito","Éxito")})["catch"](function(a){e.modalEliminacion.procesando=!1,e.grilla.reload(),e.modalEliminacion.cerrar(),c.error("Ocurrió un error al eliminar el perfil","Problema")}),this.procesando=!1,e.grilla.reload(),this.cerrar())}},e.eliminarPermisosDuplicados=function(a){for(var b=[],c=0;c<a.length;c++){var d=b.filter(function(b){return b==a[c]});0==d.length&&b.push(a[c])}return b},e.grilla=new a.NeoGrilla(b),e.grilla.largo=1,e.grilla.waiting=!0,e.grilla.active=!0,e.grilla.callback.getData=function(){e.grilla.ds.getROLES(e.grilla.mostrando,e.grilla.paginaActual,e.grilla.searchTerms.length>3?e.grilla.searchTerms:"",e.grilla.ordenDireccion).then(function(a){e.grilla.aux=a.data,e.grilla.ds.getRolesPermisos("").then(function(a){for(var b=0;b<e.grilla.aux.length;b++){var c=a.data.filter(function(a){return a.ID==e.grilla.aux[b].Id});e.grilla.aux[b].Permisos=c}e.grilla.resultado=e.grilla.aux,e.grilla.finishReload()})})},e.grilla.callback.getCountPaginacion=function(){e.grilla.ds.countROLES(e.grilla.searchTerms.length>3?e.grilla.searchTerms:"").then(function(a){e.grilla.finishPaginacion(a)})},e.grilla.reload(),e.toggleFarmaco=function(){e.grilla.waiting||(e.grilla.farmaco.toggle?(e.grilla.activos="activo",e.grilla.farmaco.toggle=!1,e.grilla.farmaco.clase="fa fa-square-o"):(e.grilla.activos="todos",e.grilla.farmaco.toggle=!0,e.grilla.farmaco.clase="fa fa-check-square-o"),e.grilla.reload())},e.sortNombre=function(a){e.doSort("NOMBRE_GENERICO",a)},e.doSort=function(a,b){var c=!1;b.target.classList.contains("selected")&&(c=!0),b.target.classList.contains("selected")?b.target.classList.toggle("fa-rotate-180"):($(".grilla thead th i").removeClass("selected"),$(".grilla thead th i").removeClass("fa-rotate-180"),b.target.classList.add("selected")),e.grilla.sort(a,c)},a.toggleInsumo=function(){!e.grilla.waiting&&e.grilla.farmaco.toggle&&(e.grilla.insumo.toggle?(e.grilla.insumo.toggle=!1,e.grilla.insumo.clase="fa fa-square-o"):(e.grilla.insumo.toggle=!0,e.grilla.insumo.clase="fa fa-check-square-o"),e.grilla.reload())},e.escogerRayen=function(){e.escogerTipoFarmacia(!1)},e.escogerPopular=function(){e.escogerTipoFarmacia(!0)},e.escogerTipoFarmacia=function(a){e.grilla.waiting||(e.grilla.esFarmaciaPopular=a,e.grilla.reload())},e}angular.module("mantenedorAdmPerfil").controller("admPerfilController",a),a.$inject=["$rootScope","dataService","toastr","PERMISSIONS"]}(),function(){"use strict";function a(a,b){a.state("er.articulo",{url:"/articulo",views:{"container@":{templateUrl:"articulo/mantenedor.articulo.view.html",controller:"admissionController as adm"},"infoBarContainer@":{templateUrl:"articulo/mantenedor.articulo.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.CONSULTAR_ARTICULO,titulo:"Artículo"}})}angular.module("mantenedorAdmission",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;return c.info("Cargando Mantenedor de Artículos","Artículos"),a.moduloActivo="articulo",a.cargarIndicadoresIniciales(),e.sortId=function(a){e.doSort("ID",a)},e.sortTipo=function(a){e.doSort("LINE_ID",a)},e.sortNombre=function(a){e.doSort("NOMBRE_GENERICO",a)},e.sortAdministracion=function(a){e.doSort("UNID_ENT_ID",a)},e.sortEntrega=function(a){e.doSort("UNID_MIN_ID",a)},e.sortFactor=function(a){e.doSort("FACTOR_CONVERSION_ENTREGA",a)},e.doSort=function(a,b){var c=!1;b.target.classList.contains("selected")&&(c=!0),b.target.classList.contains("selected")?b.target.classList.toggle("fa-rotate-180"):($(".grilla thead th i").removeClass("selected"),$(".grilla thead th i").removeClass("fa-rotate-180"),b.target.classList.add("selected")),e.grilla.sort(a,c)},e.solicitud={titulo:"Solicitar",esSolicitud:!0,paso:1,mostrarPregunta:!1,busquedaRealizada:!1,form:{tipo:2,esFarmaciaRayen:!0,nombre:"",esPopular:!1,codigoIsp:"",uAdministracion:"1",uEntrega:"1",factor:"1",esValidado:!1,esCentinela:!1,esControlado:!1,esPsicotropico:!1,esMonitoreado:!1,esFarmaciaPopular:0},procesando:!1,textoProcesando:"",duplicado:{nombre:!1},requerido:{buscado:!1,buscadoMinimo:!1,nombre:!1,uAdministracion:!1,uEntrega:!1,factor:!1,codigoIspLargo:!1},continuar:function(){return!this.busquedaRealizada||e.minigrilla.waiting?!1:void(e.solicitud.paso=2)},buscarSimilares:function(a){return void 0!=a&&13!=a.keyCode?!1:""==e.minigrilla.searchTerms?(e.solicitud.requerido.buscado=!0,!1):e.minigrilla.searchTerms.length<4?(e.solicitud.requerido.buscado=!1,e.solicitud.requerido.buscadoMinimo=!0,!1):(this.busquedaRealizada=!0,e.solicitud.mostrarPregunta=!0,e.solicitud.requerido.buscado=!1,e.solicitud.requerido.buscadoMinimo=!1,this.form.nombre=e.minigrilla.searchTerms,e.minigrilla.esFarmaciaPopular="1"==e.solicitud.form.esFarmaciaPopular?!0:!1,e.minigrilla.oculto=!1,e.minigrilla.paginaActual=1,void e.minigrilla.reload())},cancelar:function(){a.closeModal("#formularioArticulo"),e.minigrilla.searchTerms="",this.volver()},volver:function(){this.paso=1,this.mostrarPregunta=!1,e.minigrilla.oculto=!0,e.minigrilla.sinResultado=!1,this.busquedaRealizada=!1,this.form.tipo=2,this.form.esFarmaciaRayen=!0,this.form.nombre="",this.form.esPopular=!1,this.form.codigoIsp="",this.form.uAdministracion="1",this.form.uEntrega="1",this.form.factor="1",this.form.esValidado=!1,this.form.esCentinela=!1,this.form.esControlado=!1,this.form.esPsicotropico=!1,this.form.esMonitoreado=!1,this.form.esFarmaciaPopular=0,this.procesando=!1,this.duplicado.nombre=!1,this.requerido.buscado=!1,this.requerido.nombre=!1,this.requerido.uAdministracion=!1,this.requerido.uEntrega=!1,this.requerido.factor=!1,this.requerido.codigoIspLargo=!1},validar:function(){var a=!0;return this.requerido.nombre=!1,this.requerido.uAdministracion=!1,this.requerido.uEntrega=!1,this.requerido.factor=!1,this.duplicado.nombre=!1,this.requerido.codigoIspLargo=!1,""==this.form.nombre&&(this.requerido.nombre=!0,a=!1),""!=this.form.codigoIsp&&this.form.codigoIsp.length>20&&(this.requerido.codigoIspLargo=!0,a=!1),(""==this.form.uAdministracion||"nulo"==this.form.uAdministracion)&&(this.requerido.uAdministracion=!0,a=!1),(""==this.form.uEntrega||"nulo"==this.form.uEntrega)&&(this.requerido.uEntrega=!0,a=!1),""==this.form.factor&&(this.requerido.factor=!0,a=!1),a?!0:!1},solicitar:function(){if(e.solicitud.procesando)return!1;if(e.solicitud.procesando=!0,e.solicitud.textoProcesando="Validando...",!this.validar())return e.solicitud.procesando=!1,!1;var d={};d=2==e.solicitud.form.tipo?{tipo:e.solicitud.form.tipo,uAdministracion:e.solicitud.form.uAdministracion,uEntrega:e.solicitud.form.uEntrega,nombre:e.solicitud.form.nombre,codigoIsp:e.solicitud.form.codigoIsp,factor:e.solicitud.form.factor,esValidado:e.solicitud.form.esValidado?1:0,esControlado:e.solicitud.form.esControlado?1:0,esMonitoreado:e.solicitud.form.esMonitoreado?1:0,esPsicotropico:e.solicitud.form.esPsicotropico?1:0,esCentinela:e.solicitud.form.esCentinela?1:0,estado:1,esFarmaciaPopular:"1"==e.solicitud.form.esFarmaciaPopular?1:0}:{tipo:e.solicitud.form.tipo,uAdministracion:"44",uEntrega:"44",nombre:e.solicitud.form.nombre,codigoIsp:e.solicitud.form.codigoIsp,factor:1,esValidado:0,esControlado:0,esMonitoreado:0,esPsicotropico:0,esCentinela:0,estado:1},b.getARTI(1,1,"ID","desc",2==e.solicitud.form.tipo?"farmaco":"insumo",!e.solicitud.form.esFarmaciaRayen,e.solicitud.form.nombre,-1,!0).then(function(f){return e.solicitud.validando=!1,f.data.length>0?(e.solicitud.duplicado.nombre=!0,e.solicitud.procesando=!1,!1):void(e.solicitud.esSolicitud?(e.solicitud.textoProcesando="Solicitando...",d.userId=a.user.data.AspNetUserId,b.postMSA(d).then(function(b){""!=b.data.ID?(a.closeModal("#solicitarArticulo"),e.solicitud.cancelar(),c.success("Solicitud generada con éxito","Artículos")):(c.error("Ocurrio un error al generar la solicitud","Artículos"),e.solicitud.procesando=!1),e.solicitud.procesando=!1,a.cargarIndicadoresIniciales()})["catch"](function(a){c.error("Ocurrio un error al generar la solicitud","Artículos"),e.solicitud.procesando=!1})):(e.solicitud.textoProcesando="Creando...",b.postARTI(d).then(function(b){""!=b.data.ID?(a.closeModal("#solicitarArticulo"),e.solicitud.cancelar(),c.success("Artículo creado con éxito","Artículos")):(c.error("Ocurrio un error al crear el artículo","Artículos"),e.solicitud.procesando=!1),e.solicitud.procesando=!1})))})}},e.grilla=new a.NeoGrilla(b),e.grilla.active=!0,e.grilla.callback.getData=function(){var a="";e.grilla.farmaco.toggle&&!e.grilla.insumo.toggle&&(a="farmaco"),!e.grilla.farmaco.toggle&&e.grilla.insumo.toggle&&(a="insumo"),b.getARTI(e.grilla.mostrando,e.grilla.paginaActual,e.grilla.orden,e.grilla.ordenDireccion,a,e.grilla.esFarmaciaPopular,e.grilla.searchTerms.length>3?e.grilla.searchTerms:"").then(function(a){e.grilla.resultado=a.data,e.grilla.finishReload()})},e.grilla.callback.getCountPaginacion=function(){var a="";e.grilla.farmaco.toggle&&!e.grilla.insumo.toggle&&(a="farmaco"),!e.grilla.farmaco.toggle&&e.grilla.insumo.toggle&&(a="insumo"),b.countARTI(a,e.grilla.esFarmaciaPopular,e.grilla.searchTerms.length>3?e.grilla.searchTerms:"").then(function(a){e.grilla.finishPaginacion(a)})},e.grilla.reload(),e.modal={detalle:{articulo:void 0,show:function(b){return a.user.permisos.crearArticulo?(e.modal.detalle.articulo=e.grilla.resultado[b],void $("#detalleArticulo").foundation("reveal","open")):!1}},checked:function(a){return"1"==a||1==a?"checked":""}},a.subtitle="Lista de atención",a.moduleTitle="Maestro de Artículos",e.dropdown={solicitar:!1,crear:!1,solicitarDir:!1,crearDir:!1,gridCounter:!1},e.showDropDown=function(a){a?e.dropdown.solicitar?e.dropdown.solicitar=!1:e.dropdown.solicitar=!0:e.dropdown.crear?e.dropdown.crear=!1:e.dropdown.crear=!0},e.showDropDownDir=function(a){a?e.dropdown.solicitarDir?e.dropdown.solicitarDir=!1:e.dropdown.solicitarDir=!0:e.dropdown.crearDir?e.dropdown.crearDir=!1:e.dropdown.crearDir=!0},e.showDropDownGridCounter=function(){e.dropdown.gridCounter?e.dropdown.gridCounter=!1:e.dropdown.gridCounter=!0},e.solicitarArticulo=function(b,c){e.dropdown.solicitar=!1,e.dropdown.crear=!1,e.dropdown.solicitarDir=!1,e.dropdown.crearDir=!1,e.solicitud.titulo="Solicitar",e.solicitud.esSolicitud=!0,b||(e.solicitud.titulo="Crear",e.solicitud.esSolicitud=!1),e.solicitud.form.tipo=2,e.minigrilla.farmaco.toggle=!0,e.minigrilla.insumo.toggle=!1,c||(e.solicitud.form.tipo=3,e.minigrilla.farmaco.toggle=!1,e.minigrilla.insumo.toggle=!0),a.showModal("#formularioArticulo")},e.solicitarArticuloDirecto=function(a,b){e.dropdown.solicitar=!1,e.dropdown.crear=!1,e.dropdown.solicitarDir=!1,e.dropdown.crearDir=!1,e.minigrilla.searchTerms=e.grilla.searchTerms,e.solicitud.paso=2,e.solicitud.form.nombre=e.grilla.searchTerms,e.solicitarArticulo(a,b)},a.toggleFarmaco=function(){!e.grilla.waiting&&e.grilla.insumo.toggle&&(e.grilla.farmaco.toggle?(e.grilla.farmaco.toggle=!1,e.grilla.farmaco.clase="fa fa-square-o"):(e.grilla.farmaco.toggle=!0,e.grilla.farmaco.clase="fa fa-check-square-o"),e.grilla.reload())},a.toggleInsumo=function(){!e.grilla.waiting&&e.grilla.farmaco.toggle&&(e.grilla.insumo.toggle?(e.grilla.insumo.toggle=!1,e.grilla.insumo.clase="fa fa-square-o"):(e.grilla.insumo.toggle=!0,e.grilla.insumo.clase="fa fa-check-square-o"),e.grilla.reload())},e.escogerRayen=function(){e.escogerTipoFarmacia(!1)},e.escogerPopular=function(){e.escogerTipoFarmacia(!0)},e.escogerTipoFarmacia=function(a){e.grilla.waiting||(e.grilla.esFarmaciaPopular=a,e.grilla.reload())},a.showModal=function(a){$(a).foundation("reveal","open")},a.closeModal=function(a){$(a).foundation("reveal","close")},b.getUNI().then(function(a){e.unidades=a.data}),b.getLINE().then(function(a){e.tipoArticulos=a.data}),e.getNombreUnidad=function(a){if(void 0!=e.unidades){var b=e.unidades.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreTipoArticulo=function(a){if(void 0!=e.tipoArticulos){var b=e.tipoArticulos.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.minigrilla=new a.NeoGrilla(b),e.minigrilla.largo=1,e.minigrilla.mostrando=5,e.minigrilla.waiting=!1,e.minigrilla.oculto=!0,e.minigrilla.active=!0,e.minigrilla.callback.getData=function(){var a="";e.minigrilla.farmaco.toggle&&!e.minigrilla.insumo.toggle&&(a="farmaco"),!e.minigrilla.farmaco.toggle&&e.minigrilla.insumo.toggle&&(a="insumo"),b.getARTI(e.minigrilla.mostrando,e.minigrilla.paginaActual,e.minigrilla.orden,e.minigrilla.ordenDireccion,a,e.minigrilla.esFarmaciaPopular,e.minigrilla.searchTerms.length>3?e.minigrilla.searchTerms:"").then(function(a){e.minigrilla.resultado=a.data,e.minigrilla.finishReload()})},e.minigrilla.callback.getCountPaginacion=function(){var a="";e.minigrilla.farmaco.toggle&&!e.minigrilla.insumo.toggle&&(a="farmaco"),!e.minigrilla.farmaco.toggle&&e.minigrilla.insumo.toggle&&(a="insumo"),b.countARTI(a,e.minigrilla.esFarmaciaPopular,e.minigrilla.searchTerms.length>3?e.minigrilla.searchTerms:"").then(function(a){e.minigrilla.finishPaginacion(a)})},e.minigrilla.searchTermsChange=function(){this.searchTermsModificado=!0},e}angular.module("mantenedorAdmission").controller("admissionController",a),a.$inject=["$rootScope","dataService","toastr","toastrNoDismiss"]}(),function(){"use strict";function a(a,b){a.state("er.solicitud",{url:"/articulo/solicitud",views:{"container@":{templateUrl:"solicitud/mantenedor.solicitud.view.html",controller:"solicitudController as adm"},"infoBarContainer@":{templateUrl:"solicitud/mantenedor.solicitud.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.CONSULTAR_SOLICITUD_ARTICULO,titulo:"Solicitud de Artículo"}})}angular.module("mantenedorSolicitud",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;return c.info("Cargando Mantenedor","Solicitudes"),a.menu={articulo:"active"},a.moduloActivo="solicitud",a.cargarIndicadoresIniciales(),e.usuarios=[],b.getListaUSER().then(function(a){e.usuarios=a.data}),e.getNombrePorId=function(a){var b=e.usuarios.filter(function(b){return b.Id==a});return 0==b.length?"":b[0].FullName},e.moduleTitle="Mis Solicitudes",e.subtitle="Lista de atención",e.solicitud={titulo:"Solicitar",paso:1,mostrarPregunta:!1,procesando:!1,index:0,form:{id:0,tipo:2,esFarmaciaRayen:!0,nombre:"",esPopular:!1,codigoIsp:"",uAdministracion:"1",uEntrega:"1",factor:"1",esFarmacoValido:!1,comentario:""},validando:!1,textoValidando:"Validando...",duplicado:{nombre:!1},requerido:{buscado:!1,nombre:!1,uAdministracion:!1,uEntrega:!1,factor:!1,comentario:!1},show:function(){$("#formularioSolicitud").foundation("reveal","open")},cancelar:function(){a.closeModal("#formularioSolicitud"),this.paso=1,this.mostrarPregunta=!1,e.solicitud.comentarioId="",this.validando=!1,this.form.tipo=2,this.form.esFarmaciaRayen=!0,this.form.nombre="",this.form.esPopular=!1,this.form.codigoIsp="",this.form.uAdministracion="1",this.form.uEntrega="1",this.form.factor="1",this.form.comentario="",this.requerido.buscado=!1,this.requerido.nombre=!1,this.requerido.uAdministracion=!1,this.requerido.uEntrega=!1,this.requerido.factor=!1,this.requerido.comentario=!1,this.requerido.codigoIspLargo=!1},validar:function(){var a=!0;return this.requerido.nombre=!1,this.requerido.uAdministracion=!1,this.requerido.uEntrega=!1,this.requerido.factor=!1,this.requerido.comentario=!1,this.duplicado.nombre=!1,this.requerido.codigoIspLargo=!1,""==this.form.nombre&&(this.requerido.nombre=!0,a=!1),this.form.codigoIsp.length>20&&(this.requerido.codigoIspLargo=!0,
a=!1),(""==this.form.uAdministracion||"nulo"==this.form.uAdministracion)&&(this.requerido.uAdministracion=!0,a=!1),(""==this.form.uEntrega||"nulo"==this.form.uEntrega)&&(this.requerido.uEntrega=!0,a=!1),""==this.form.factor&&(this.requerido.factor=!0,a=!1),""==this.form.comentario&&(this.requerido.comentario=!0,a=!1),a?!0:!1},reingresar:function(){e.solicitud.solicitar(3)},cancelarSolicitud:function(){e.solicitud.solicitar(4)},solicitar:function(d){if(!this.procesando){if(this.procesando=!0,e.solicitud.validando=!0,e.solicitud.textoValidando="Validando...",!this.validar())return e.solicitud.validando=!1,this.procesando=!1,!1;var f=angular.copy(e.solicitud.dataOriginal);f.ID=e.solicitud.form.id,f.LINE_ID=e.solicitud.form.tipo,f.UNID_MIN_ID=e.solicitud.form.uAdministracion,f.UNID_ENT_ID=e.solicitud.form.uEntrega,f.NOMBRE_GENERICO=e.solicitud.form.nombre,f.CODIGO_ISP=e.solicitud.form.codigoIsp,f.FACTOR_CONVERSION=e.solicitud.form.factor,f.MES_ID=d,b.getARTI(1,1,"ID","desc",2==e.solicitud.form.tipo?"farmaco":"insumo",!e.solicitud.form.esFarmaciaRayen,e.solicitud.form.nombre).then(function(g){return g.data.length>0&&4!=d?(e.solicitud.validando=!1,e.solicitud.procesando=!1,e.solicitud.duplicado.nombre=!0,!1):(e.solicitud.textoValidando="Actualizando...",void b.postMHS({msaId:f.ID,comentario:"["+e.getNombreEstado(d)+"]: "+e.solicitud.form.comentario,userId:a.user.data.AspNetUserId}).then(function(a){void 0!=a.data.ID&&(e.solicitud.comentario=a.data,b.putMSA(f).then(function(a){""!=a.data.ID?b.activarMHS(e.solicitud.comentario).then(function(a){c.success("Solicitud actualizada con éxito","Artículos"),e.solicitud.cancelar(),e.grilla.reload(),e.solicitud.procesando=!1,e.grilla.reload()}):(c.error("Ocurrio un error al actualizar la solicitud","Artículos"),b.eliminarMHS(e.solicitud.comentario).then(function(a){e.solicitud.validando=!1,e.solicitud.procesando=!1,e.grilla.reload()}))}))})["catch"](function(a){e.solicitud.procesando=!1,e.grilla.reload()}))})["catch"](function(a){return e.solicitud.validando=!1,e.solicitud.procesando=!1,e.solicitud.duplicado.nombre=!0,c.error("Ocurrio un error al consultar el servidor, por favor reintente","Artículos"),e.grilla.reload(),!1})}}},e.grilla=new a.NeoGrilla(b),e.grilla.orden="ID",e.grilla.ordenDireccion="desc",e.grilla.callback.getData=function(){b.getMSA(e.grilla.mostrando,e.grilla.paginaActual,e.grilla.orden,e.grilla.ordenDireccion,e.grilla.obtener,e.grilla.esFarmaciaPopular,e.grilla.searchTerms.length>3?e.grilla.searchTerms:"",[],a.user.Id).then(function(a){for(var b=0;b<a.data.length;b++)a.data[b].FullName=e.getNombrePorId(a.data[b].ASPNET_USER_ID);e.grilla.resultado=a.data,e.grilla.waiting=!1,0==e.grilla.resultado.length?(e.grilla.sinResultado=!0,e.grilla.paginacion.mostrar=!1):e.grilla.sinResultado=!1;var b=0;for(b=0;b<e.grilla.resultado.length;b++)e.grilla.historial[b]=e.getActivos(e.grilla.resultado[b].MHS_HISTORIAL_SOLICITUD),e.grilla.showHistorial[b]=!1;e.grilla.finishReload()})},e.grilla.callback.getCountPaginacion=function(){b.countMSA(e.grilla.obtener,e.grilla.esFarmaciaPopular,e.grilla.searchTerms,[],a.user.Id).then(function(a){e.grilla.finishPaginacion(a)})},e.grilla.active=!0,e.grilla.reload(),e.modal={detalle:{articulo:void 0,show:function(a){e.modal.detalle.articulo=e.grilla.resultado[a],e.modal.detalle.historial=e.grilla.historial[a],$("#detalleArticulo").foundation("reveal","open")},cerrar:function(){if((4==e.modal.detalle.articulo.MES_ID||5==e.modal.detalle.articulo.MES_ID)&&e.modal.detalle.articulo.ASPNET_USER_ID!=e.modal.detalle.articulo.VISTO_POR){var c=angular.copy(e.modal.detalle.articulo);c.VISTO_POR=a.user.data.AspNetUserId,b.putMSA(c).then(function(b){a.cargarIndicadoresIniciales()})}a.closeModal("#detalleArticulo")}},checked:function(a){return"1"==a||1==a?"checked":""}},e.solicitarArticulo=function(b){e.solicitud.titulo="Revise su solicitud de Nuevo Artículo",e.solicitud.dataOriginal=e.grilla.resultado[b],e.solicitud.historial=e.grilla.historial[b],e.solicitud.index=b,e.solicitud.form.id=e.grilla.resultado[b].ID,e.solicitud.form.tipo=e.grilla.resultado[b].LINE_ID,e.solicitud.form.nombre=e.grilla.resultado[b].NOMBRE_GENERICO,e.solicitud.form.codigoIsp=e.grilla.resultado[b].CODIGO_ISP,e.solicitud.form.uAdministracion=""+e.grilla.resultado[b].UNID_MIN_ID,e.solicitud.form.uEntrega=""+e.grilla.resultado[b].UNID_ENT_ID,e.solicitud.form.factor=e.grilla.resultado[b].FACTOR_CONVERSION,a.showModal("#formularioSolicitud")},e.show=function(b){2==e.grilla.resultado[b].MES_ID&&a.user.permisos.solicitarArticulo?e.solicitarArticulo(b):e.modal.detalle.show(b)},e.sortId=function(a){e.doSort("ID",a)},e.sortTipo=function(a){e.doSort("LINE_ID",a)},e.sortNombre=function(a){e.doSort("NOMBRE_GENERICO",a)},e.sortEstado=function(a){e.doSort("MES_ID",a)},e.doSort=function(a,b){var c=!1;b.target.classList.contains("selected")&&(c=!0),b.target.classList.contains("selected")?b.target.classList.toggle("fa-rotate-180"):($(".grilla thead th i").removeClass("selected"),$(".grilla thead th i").removeClass("fa-rotate-180"),b.target.classList.add("selected")),e.grilla.sort(a,c)},a.toggleFarmaco=function(){!e.grilla.waiting&&e.grilla.insumo.toggle&&(e.grilla.farmaco.toggle?(e.grilla.farmaco.toggle=!1,e.grilla.farmaco.clase="fa fa-square-o"):(e.grilla.farmaco.toggle=!0,e.grilla.farmaco.clase="fa fa-check-square-o"),e.grilla.reload())},a.toggleInsumo=function(){!e.grilla.waiting&&e.grilla.farmaco.toggle&&(e.grilla.insumo.toggle?(e.grilla.insumo.toggle=!1,e.grilla.insumo.clase="fa fa-square-o"):(e.grilla.insumo.toggle=!0,e.grilla.insumo.clase="fa fa-check-square-o"),e.grilla.reload())},e.escogerRayen=function(){e.escogerTipoFarmacia(!1)},e.escogerPopular=function(){e.escogerTipoFarmacia(!0)},e.escogerTipoFarmacia=function(a){e.grilla.waiting||(e.grilla.esFarmaciaPopular=a,e.grilla.reload())},a.showModal=function(a){$(a).foundation("reveal","open")},a.closeModal=function(a){$(a).foundation("reveal","close")},b.getUNI().then(function(a){e.unidades=a.data}),b.getLINE().then(function(a){e.tipoArticulos=a.data}),b.getMES().then(function(a){e.estadoSolicitudes=a.data}),e.grilla.reload(),e.getNombreUnidad=function(a){if(void 0!=e.unidades){var b=e.unidades.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreTipoArticulo=function(a){if(void 0!=e.tipoArticulos){var b=e.tipoArticulos.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreEstado=function(a){if(void 0!=e.estadoSolicitudes){var b=e.estadoSolicitudes.filter(function(b){return b.ID==a});if(b.length>0)return b[0].NOMBRE}return""},e.getPrimerComentario=function(b){return a.getPrimerComentario(b,function(a){return e.getNombrePorId(a)})},e.showHistorial=function(a){e.grilla.showHistorial[a]?e.grilla.showHistorial[a]=!1:e.grilla.showHistorial[a]=!0},e.getActivos=function(a){if(void 0!=a){var b=a.filter(function(a){return 1==a.ACTIVO&&0==a.ELIMINADO});if(b.length>0)return b}return[]},e.pressEnterSearch=function(a){13==a.keyCode&&e.grilla.reload()},e}angular.module("mantenedorSolicitud").controller("solicitudController",a),a.$inject=["$rootScope","dataService","toastr","toastrNoDismiss"]}(),function(){"use strict";function a(a,b){a.state("er.solicitudFarmaco",{url:"/articulo/solicitud/farmaco",views:{"container@":{templateUrl:"solicitudfarmaco/mantenedor.solicitudfarmaco.view.html",controller:"solicitudFarmacoController as adm"},"infoBarContainer@":{templateUrl:"solicitudfarmaco/mantenedor.solicitudfarmaco.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.APROBAR_SOLICITUD_FARMACO,titulo:"Solicitud de Fármaco"}})}angular.module("mantenedorSolicitudFarmaco",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;return c.info("Cargando Mantenedor","Solicitudes"),a.menu={articulo:"active"},a.moduloActivo="farmaco",a.cargarIndicadoresIniciales(),e.usuarios=[],b.getListaUSER().then(function(a){e.usuarios=a.data}),e.getNombrePorId=function(a){var b=e.usuarios.filter(function(b){return b.Id==a});return 0==b.length?"":b[0].FullName},e.moduleTitle="Farmacos Pendientes de Aprobación",e.subtitle="Lista de atención",e.solicitud={titulo:"Aprobar/Objetar/Rechazar Solicitud de Nuevo Artículo",paso:1,mostrarPregunta:!1,index:0,form:{id:0,tipo:2,esFarmaciaRayen:!0,nombre:"",esPopular:!1,codigoIsp:"",uAdministracion:"1",uEntrega:"1",factor:"1",esFarmacoValido:!1,comentario:"",stockMinimo:10,stockCritico:10},validando:!1,textoValidando:"Validando...",duplicado:{nombre:!1},requerido:{buscado:!1,nombre:!1,uAdministracion:!1,uEntrega:!1,factor:!1,comentario:!1,stockMinimo:!1,stockCritico:!1,codigoIspLargo:!1},show:function(){$("#formularioSolicitud").foundation("reveal","open")},continuar:function(){return""==e.minigrilla.searchTerms||e.minigrilla.waiting?!1:void(e.solicitud.paso=2)},buscarSimilares:function(a){return void 0!=a&&13!=a.keyCode?!1:""==e.minigrilla.searchTerms?(e.solicitud.requerido.buscado=!0,!1):(e.solicitud.mostrarPregunta=!0,e.solicitud.requerido.buscado=!1,this.form.nombre=e.minigrilla.searchTerms,e.minigrilla.oculto=!1,void e.minigrilla.reload())},cancelar:function(){a.closeModal("#formularioSolicitud"),e.solicitud.comentarioId="",this.validando=!1,this.form.tipo=2,this.form.esFarmaciaRayen=!0,this.form.nombre="",this.form.esPopular=!1,this.form.codigoIsp="",this.form.uAdministracion="1",this.form.uEntrega="1",this.form.factor="1",this.form.comentario="",this.form.stockMinimo=10,this.form.stockCritico=10,this.requerido.buscado=!1,this.requerido.nombre=!1,this.requerido.uAdministracion=!1,this.requerido.uEntrega=!1,this.requerido.factor=!1,this.requerido.comentario=!1,this.requerido.codigoIspLargo=!1},validar:function(){var a=!0;return this.requerido.nombre=!1,this.requerido.uAdministracion=!1,this.requerido.uEntrega=!1,this.requerido.factor=!1,this.requerido.comentario=!1,this.requerido.stockMinimo=!1,this.requerido.stockCritico=!1,this.duplicado.nombre=!1,this.requerido.codigoIspLargo=!1,""==this.form.nombre&&(this.requerido.nombre=!0,a=!1),this.form.codigoIsp.length>20&&(this.requerido.codigoIspLargo=!0,a=!1),(""==this.form.uAdministracion||"nulo"==this.form.uAdministracion)&&(this.requerido.uAdministracion=!0,a=!1),(""==this.form.uEntrega||"nulo"==this.form.uEntrega)&&(this.requerido.uEntrega=!0,a=!1),""==this.form.factor&&(this.requerido.factor=!0,a=!1),""==this.form.comentario&&(this.requerido.comentario=!0,a=!1),""==this.form.stockMinimo&&(this.requerido.stockMinimo=!0,a=!1),""==this.form.stockCritico&&(this.requerido.stockCritico=!0,a=!1),a?!0:(c.error("Existen errores en el formulario","Error"),!1)},rechazar:function(){e.solicitud.actualizar(4)},objetar:function(){e.solicitud.actualizar(2)},crear:function(){e.solicitud.actualizar(5)},actualizar:function(a){return e.solicitud.validando=!0,e.solicitud.textoValidando="Validando...",this.validar()?void b.getARTI(1,1,"ID","desc","farmaco",!e.solicitud.form.esFarmaciaRayen,e.solicitud.form.nombre,-1,!0).then(function(d){if(d.data.length>0&&4!=a)return e.solicitud.validando=!1,e.solicitud.duplicado.nombre=!0,c.error("Existen errores en el formulario","Error"),!1;if(5==a){e.solicitud.textoProcesando="Creando Fármaco...";var f={tipo:e.solicitud.form.tipo,uAdministracion:e.solicitud.form.uAdministracion,uEntrega:e.solicitud.form.uEntrega,nombre:e.solicitud.form.nombre,codigoIsp:e.solicitud.form.codigoIsp,factor:e.solicitud.form.factor,esValidado:e.solicitud.form.esValidado?1:0,esControlado:e.solicitud.form.esControlado?1:0,esMonitoreado:e.solicitud.form.esMonitoreado?1:0,esPsicotropico:e.solicitud.form.esPsicotropico?1:0,esCentinela:e.solicitud.form.esCentinela?1:0,estado:1};b.postARTI(f).then(function(b){""!=b.data.ID?(e.solicitud.update(a),c.success("Artículo creado con éxito","Artículos")):(c.error("Ocurrio un error al crear el artículo","Artículos"),e.solicitud.validando=!1)})["catch"](function(a){c.error("Ocurrio un error al crear el artículo","Artículos"),e.solicitud.validando=!1})}else e.solicitud.update(a)})["catch"](function(a){e.solicitud.validando=!1,c.error("Ocurrio un error al conectarse a la red, por favor vuelva a intentarlo","Artículos"),e.grilla.reload()}):(e.solicitud.validando=!1,!1)},update:function(d){var f=angular.copy(e.solicitud.dataOriginal);f.ID=e.solicitud.form.id,f.LINE_ID=e.solicitud.form.tipo,f.UNID_MIN_ID=e.solicitud.form.uAdministracion,f.UNID_ENT_ID=e.solicitud.form.uEntrega,f.NOMBRE_GENERICO=e.solicitud.form.nombre,f.CODIGO_ISP=e.solicitud.form.codigoIsp,f.FACTOR_CONVERSION=e.solicitud.form.factor,f.MES_ID=d,f.STOCK_MINIMO=e.solicitud.form.stockMinimo,f.STOCK_CRITICO=e.solicitud.form.stockCritico,f.MARCAR_FARMACO_VALIDO=e.solicitud.form.esValidado,f.CENTINELA=e.solicitud.form.esCentinela,f.CONTROLADO=e.solicitud.form.esControlado,f.MONITOREADO=e.solicitud.form.esMonitoreado,f.PSICOTROPICO=e.solicitud.form.esPsicotropico,f.VISTO_POR=a.user.data.AspNetUserId,e.solicitud.textoValidando="Actualizando Solicitud...",b.postMHS({msaId:f.ID,comentario:"["+e.getNombreEstado(d)+"]: "+e.solicitud.form.comentario,userId:a.user.data.AspNetUserId}).then(function(d){void 0!=d.data.ID&&(e.solicitud.comentario=d.data,b.putMSA(f).then(function(d){""!=d.data.ID?b.activarMHS(e.solicitud.comentario).then(function(a){c.success("Solicitud actualizada con éxito","Artículos"),e.solicitud.cancelar(),e.grilla.reload()}):(c.error("Ocurrio un error al actualizar la solicitud","Artículos"),b.eliminarMHS(e.solicitud.comentario).then(function(a){e.solicitud.validando=!1})),a.cargarIndicadoresIniciales()})["catch"](function(a){c.error("Se produjo un error al actualizar la solicitud","Error"),e.solicitud.validando=!1,e.grilla.reload()}))})["catch"](function(a){c.error("Se produjo un error al actualizar la solicitud","Error"),e.solicitud.validando=!1,e.grilla.reload()})}},e.grilla=new a.NeoGrilla(b),e.grilla.estados=[1,3],e.grilla.orden="ID",e.grilla.ordenDireccion="desc",e.grilla.callback.getData=function(){e.grilla.ds.getMSA(e.grilla.mostrando,e.grilla.paginaActual,e.grilla.orden,e.grilla.ordenDireccion,"farmaco","",e.grilla.searchTerms.length>3?e.grilla.searchTerms:"",e.grilla.estados,"").then(function(a){e.grilla.resultado=a.data,e.grilla.waiting=!1,0==e.grilla.resultado.length?(e.grilla.sinResultado=!0,e.grilla.paginacion.mostrar=!1):e.grilla.sinResultado=!1;var b=0;for(b=0;b<e.grilla.resultado.length;b++)e.grilla.historial[b]=e.getActivos(e.grilla.resultado[b].MHS_HISTORIAL_SOLICITUD),e.grilla.showHistorial[b]=!1;e.grilla.finishReload()})},e.grilla.callback.getCountPaginacion=function(){e.grilla.ds.countMSA("farmaco","",e.grilla.searchTerms,e.grilla.estados,"").then(function(a){e.grilla.finishPaginacion(a)})},e.grilla.active=!0,e.modal={detalle:{articulo:void 0,show:function(a){e.modal.detalle.articulo=e.grilla.resultado[a],e.modal.detalle.historial=e.grilla.historial[a],$("#detalleArticulo").foundation("reveal","open")}},checked:function(a){return"1"==a||1==a?"checked":""}},e.solicitarArticulo=function(b){e.solicitud.dataOriginal=e.grilla.resultado[b],e.solicitud.historial=e.grilla.historial[b],e.solicitud.index=b,e.solicitud.form.id=e.grilla.resultado[b].ID,e.solicitud.form.tipo=e.grilla.resultado[b].LINE_ID,e.solicitud.form.nombre=e.grilla.resultado[b].NOMBRE_GENERICO,e.solicitud.form.codigoIsp=e.grilla.resultado[b].CODIGO_ISP,e.solicitud.form.uAdministracion=""+e.grilla.resultado[b].UNID_MIN_ID,e.solicitud.form.uEntrega=""+e.grilla.resultado[b].UNID_ENT_ID,e.solicitud.form.factor=e.grilla.resultado[b].FACTOR_CONVERSION,e.solicitud.form.esValidado=e.grilla.resultado[b].MARCAR_FARMACO_VALIDO,e.solicitud.form.esCentinela=e.grilla.resultado[b].CENTINELA,e.solicitud.form.esControlado=e.grilla.resultado[b].CONTROLADO,e.solicitud.form.esMonitoreado=e.grilla.resultado[b].MONITOREADO,e.solicitud.form.esPsicotropico=e.grilla.resultado[b].PSICOTROPICO,e.solicitud.form.esFarmaciaPopular=e.grilla.resultado[b].ES_FARMACIA_POPULAR,a.showModal("#formularioSolicitud")},e.show=function(b){a.user.permisos.aprobarSolicitudFarmaco&&(1==e.grilla.resultado[b].MES_ID||3==e.grilla.resultado[b].MES_ID)?e.solicitarArticulo(b):e.modal.detalle.show(b)},e.sortId=function(a){e.doSort("ID",a)},e.sortTipo=function(a){e.doSort("LINE_ID",a)},e.sortNombre=function(a){e.doSort("NOMBRE_GENERICO",a)},e.sortAdministracion=function(a){e.doSort("UNID_ENT_ID",a)},e.sortEntrega=function(a){e.doSort("UNID_MIN_ID",a)},e.sortFactor=function(a){e.doSort("FACTOR_CONVERSION_ENTREGA",a)},e.sortEstado=function(a){e.doSort("MES_ID",a)},e.doSort=function(a,b){var c=!1;b.target.classList.contains("selected")&&(c=!0),b.target.classList.contains("selected")?b.target.classList.toggle("fa-rotate-180"):($(".grilla thead th i").removeClass("selected"),$(".grilla thead th i").removeClass("fa-rotate-180"),b.target.classList.add("selected")),e.grilla.sort(a,c)},a.toggleFarmaco=function(){!e.grilla.waiting&&e.grilla.insumo.toggle&&(e.grilla.farmaco.toggle?(e.grilla.farmaco.toggle=!1,e.grilla.farmaco.clase="fa fa-square-o"):(e.grilla.farmaco.toggle=!0,e.grilla.farmaco.clase="fa fa-check-square-o"),e.grilla.reload())},a.toggleInsumo=function(){!e.grilla.waiting&&e.grilla.farmaco.toggle&&(e.grilla.insumo.toggle?(e.grilla.insumo.toggle=!1,e.grilla.insumo.clase="fa fa-square-o"):(e.grilla.insumo.toggle=!0,e.grilla.insumo.clase="fa fa-check-square-o"),e.grilla.reload())},e.escogerPendientes=function(){e.escogerEstados(!1)},e.escogerTodas=function(){e.escogerEstados(!0)},e.escogerEstados=function(a){e.grilla.waiting||(e.grilla.estados=a?[]:[1,2,3],e.grilla.esFarmaciaPopular=a,e.grilla.paginaActual=1,e.grilla.reload())},a.showModal=function(a){$(a).foundation("reveal","open")},a.closeModal=function(a){$(a).foundation("reveal","close")},b.getUNI().then(function(a){e.unidades=a.data}),b.getLINE().then(function(a){e.tipoArticulos=a.data}),b.getMES().then(function(a){e.estadoSolicitudes=a.data}),e.grilla.reload(),e.getNombreUnidad=function(a){if(void 0!=e.unidades){var b=e.unidades.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreTipoArticulo=function(a){if(void 0!=e.tipoArticulos){var b=e.tipoArticulos.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreEstado=function(a){if(void 0!=e.estadoSolicitudes){var b=e.estadoSolicitudes.filter(function(b){return b.ID==a});if(b.length>0)return b[0].NOMBRE}return""},e.getPrimerComentario=function(b){return a.getPrimerComentario(b,function(a){return e.getNombrePorId(a)})},e.showHistorial=function(a){e.grilla.showHistorial[a]?e.grilla.showHistorial[a]=!1:e.grilla.showHistorial[a]=!0},e.getActivos=function(a){if(void 0!=a){var b=a.filter(function(a){return 1==a.ACTIVO&&0==a.ELIMINADO});if(b.length>0)return b}return[]},e.pressEnterSearch=function(a){13==a.keyCode&&e.grilla.reload()},e}angular.module("mantenedorSolicitudFarmaco").controller("solicitudFarmacoController",a),a.$inject=["$rootScope","dataService","toastr","toastrNoDismiss"]}(),function(){"use strict";function a(a,b){a.state("er.solicitudInsumo",{url:"/articulo/solicitud/insumo",views:{"container@":{templateUrl:"solicitudinsumo/mantenedor.solicitudinsumo.view.html",controller:"solicitudInsumoController as adm"},"infoBarContainer@":{templateUrl:"solicitudinsumo/mantenedor.solicitudinsumo.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.APROBAR_SOLICITUD_INSUMO,titulo:"Solicitud de Insumo"}})}angular.module("mantenedorSolicitudInsumo",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;return c.info("Cargando Mantenedor","Solicitudes"),a.menu={articulo:"active"},a.moduloActivo="insumo",e.moduleTitle="Insumos Pendientes de Aprobación",a.cargarIndicadoresIniciales(),e.usuarios=[],b.getListaUSER().then(function(a){e.usuarios=a.data}),e.getNombrePorId=function(a){var b=e.usuarios.filter(function(b){return b.Id==a});return 0==b.length?"":b[0].FullName},e.solicitud={titulo:"Aprobar/Objetar/Rechazar Solicitud de Nuevo Artículo",paso:1,mostrarPregunta:!1,index:0,form:{id:0,tipo:2,esFarmaciaRayen:!0,nombre:"",esPopular:!1,codigoIsp:"",uAdministracion:"1",uEntrega:"1",factor:"1",esFarmacoValido:!1,comentario:"",stockMinimo:10,stockCritico:10},validando:!1,textoValidando:"Validando...",duplicado:{nombre:!1},requerido:{buscado:!1,nombre:!1,uAdministracion:!1,uEntrega:!1,factor:!1,comentario:!1,stockMinimo:!1,stockCritico:!1},show:function(){$("#formularioSolicitud").foundation("reveal","open")},continuar:function(){return""==e.minigrilla.searchTerms||e.minigrilla.waiting?!1:void(e.solicitud.paso=2)},buscarSimilares:function(a){return void 0!=a&&13!=a.keyCode?!1:""==e.minigrilla.searchTerms?(e.solicitud.requerido.buscado=!0,!1):(e.solicitud.mostrarPregunta=!0,e.solicitud.requerido.buscado=!1,this.form.nombre=e.minigrilla.searchTerms,e.minigrilla.oculto=!1,void e.minigrilla.reload())},cancelar:function(){a.closeModal("#formularioSolicitud"),e.solicitud.comentarioId="",this.validando=!1,this.form.tipo=2,this.form.esFarmaciaRayen=!0,this.form.nombre="",this.form.esPopular=!1,this.form.codigoIsp="",this.form.uAdministracion="1",this.form.uEntrega="1",this.form.factor="1",this.form.comentario="",this.form.stockMinimo=10,this.form.stockCritico=10,this.requerido.buscado=!1,this.requerido.nombre=!1,this.requerido.uAdministracion=!1,this.requerido.uEntrega=!1,this.requerido.factor=!1,this.requerido.comentario=!1,this.requerido.codigoIspLargo=!1},validar:function(){var a=!0;return this.requerido.nombre=!1,this.requerido.uAdministracion=!1,this.requerido.uEntrega=!1,this.requerido.factor=!1,this.requerido.comentario=!1,this.requerido.stockMinimo=!1,this.requerido.stockCritico=!1,this.duplicado.nombre=!1,this.requerido.codigoIspLargo=!1,""==this.form.nombre&&(this.requerido.nombre=!0,a=!1),this.form.codigoIsp.length>20&&(this.requerido.codigoIspLargo=!0,a=!1),(""==this.form.uAdministracion||"nulo"==this.form.uAdministracion)&&(this.requerido.uAdministracion=!0,a=!1),(""==this.form.uEntrega||"nulo"==this.form.uEntrega)&&(this.requerido.uEntrega=!0,a=!1),""==this.form.factor&&(this.requerido.factor=!0,a=!1),""==this.form.comentario&&(this.requerido.comentario=!0,a=!1),""==this.form.stockMinimo&&(this.requerido.stockMinimo=!0,a=!1),""==this.form.stockCritico&&(this.requerido.stockCritico=!0,a=!1),a?!0:!1},rechazar:function(){e.solicitud.actualizar(4)},objetar:function(){e.solicitud.actualizar(2)},crear:function(){e.solicitud.actualizar(5)},actualizar:function(a){return e.solicitud.validando=!0,e.solicitud.textoValidando="Validando...",this.validar()?void b.getARTI(1,1,"ID","desc","insumo",!e.solicitud.form.esFarmaciaRayen,e.solicitud.form.nombre,-1,!0).then(function(d){if(d.data.length>0&&4!=a)return e.solicitud.validando=!1,e.solicitud.duplicado.nombre=!0,!1;if(5==a){e.solicitud.textoProcesando="Creando Insumo...";var f={tipo:e.solicitud.form.tipo,uAdministracion:e.solicitud.form.uAdministracion,uEntrega:e.solicitud.form.uEntrega,nombre:e.solicitud.form.nombre,codigoIsp:e.solicitud.form.codigoIsp,factor:e.solicitud.form.factor,esValidado:e.solicitud.form.esValidado?1:0,esControlado:e.solicitud.form.esControlado?1:0,esMonitoreado:e.solicitud.form.esMonitoreado?1:0,esPsicotropico:e.solicitud.form.esPsicotropico?1:0,esCentinela:e.solicitud.form.esCentinela?1:0,estado:1};b.postARTI(f).then(function(b){""!=b.data.ID?(e.solicitud.update(a),c.success("Artículo creado con éxito","Artículos")):(c.error("Ocurrio un error al crear el artículo","Artículos"),e.solicitud.validando=!1)})["catch"](function(a){e.solicitud.validando=!1})}else e.solicitud.update(a)})["catch"](function(a){e.solicitud.validando=!1,c.error("Ocurrio un error al conectarse a la red, por favor vuelva a intentarlo","Artículos"),e.grilla.reload()}):(e.solicitud.validando=!1,!1)},update:function(d){var f=angular.copy(e.solicitud.dataOriginal);f.ID=e.solicitud.form.id,f.LINE_ID=e.solicitud.form.tipo,f.UNID_MIN_ID=e.solicitud.form.uAdministracion,f.UNID_ENT_ID=e.solicitud.form.uEntrega,f.NOMBRE_GENERICO=e.solicitud.form.nombre,f.CODIGO_ISP=e.solicitud.form.codigoIsp,f.FACTOR_CONVERSION=e.solicitud.form.factor,f.MES_ID=d,f.STOCK_MINIMO=e.solicitud.form.stockMinimo,f.STOCK_CRITICO=e.solicitud.form.stockCritico,f.VISTO_POR=a.user.data.AspNetUserId,e.solicitud.textoValidando="Actualizando Solicitud...",b.postMHS({msaId:f.ID,comentario:"["+e.getNombreEstado(d)+"]: "+e.solicitud.form.comentario,userId:a.user.data.AspNetUserId}).then(function(d){void 0!=d.data.ID&&(e.solicitud.comentario=d.data,b.putMSA(f).then(function(d){""!=d.data.ID?b.activarMHS(e.solicitud.comentario).then(function(b){c.success("Solicitud actualizada con éxito","Artículos"),e.solicitud.cancelar(),e.grilla.reload(),a.cargarIndicadoresIniciales()}):(c.error("Ocurrio un error al actualizar la solicitud","Artículos"),b.eliminarMHS(e.solicitud.comentario).then(function(a){e.solicitud.validando=!1}))}))})["catch"](function(a){e.solicitud.validando=!1,c.error("Ocurrio un error al conectarse a la red, por favor vuelva a intentarlo","Artículos"),e.grilla.reload()})}},e.grilla=new a.NeoGrilla(b),e.grilla.estados=[1,3],e.grilla.orden="ID",e.grilla.ordenDireccion="desc",e.grilla.callback.getData=function(){e.grilla.ds.getMSA(e.grilla.mostrando,e.grilla.paginaActual,e.grilla.orden,e.grilla.ordenDireccion,"insumo","",e.grilla.searchTerms.length>3?e.grilla.searchTerms:"",e.grilla.estados,"").then(function(a){e.grilla.resultado=a.data,e.grilla.waiting=!1,0==e.grilla.resultado.length?(e.grilla.sinResultado=!0,e.grilla.paginacion.mostrar=!1):e.grilla.sinResultado=!1;var b=0;for(b=0;b<e.grilla.resultado.length;b++)e.grilla.historial[b]=e.getActivos(e.grilla.resultado[b].MHS_HISTORIAL_SOLICITUD),e.grilla.showHistorial[b]=!1;e.grilla.finishReload()})},e.grilla.callback.getCountPaginacion=function(){e.grilla.ds.countMSA("insumo","",e.grilla.searchTerms,e.grilla.estados,"").then(function(a){e.grilla.finishPaginacion(a)})},e.grilla.active=!0,e.modal={detalle:{articulo:void 0,show:function(a){e.modal.detalle.articulo=e.grilla.resultado[a],e.modal.detalle.historial=e.grilla.historial[a],$("#detalleArticulo").foundation("reveal","open")}},checked:function(a){return"1"==a||1==a?"checked":""}},e.solicitarArticulo=function(b){e.solicitud.dataOriginal=e.grilla.resultado[b],e.solicitud.historial=e.grilla.historial[b],e.solicitud.index=b,e.solicitud.form.id=e.grilla.resultado[b].ID,e.solicitud.form.tipo=e.grilla.resultado[b].LINE_ID,e.solicitud.form.nombre=e.grilla.resultado[b].NOMBRE_GENERICO,e.solicitud.form.codigoIsp=e.grilla.resultado[b].CODIGO_ISP,e.solicitud.form.uAdministracion=""+e.grilla.resultado[b].UNID_MIN_ID,e.solicitud.form.uEntrega=""+e.grilla.resultado[b].UNID_ENT_ID,e.solicitud.form.factor=e.grilla.resultado[b].FACTOR_CONVERSION,e.solicitud.form.esValidado=e.grilla.resultado[b].MARCAR_FARMACO_VALIDO,e.solicitud.form.esCentinela=e.grilla.resultado[b].CENTINELA,e.solicitud.form.esControlado=e.grilla.resultado[b].CONTROLADO,e.solicitud.form.esMonitoreado=e.grilla.resultado[b].MONITOREADO,e.solicitud.form.esPsicotropico=e.grilla.resultado[b].PSICOTROPICO,e.solicitud.form.esFarmaciaPopular=e.grilla.resultado[b].ES_FARMACIA_POPULAR,a.showModal("#formularioSolicitud")},e.show=function(b){a.user.permisos.aprobarSolicitudInsumo&&(1==e.grilla.resultado[b].MES_ID||3==e.grilla.resultado[b].MES_ID)?e.solicitarArticulo(b):e.modal.detalle.show(b)},e.sortId=function(a){e.doSort("ID",a)},e.sortTipo=function(a){e.doSort("LINE_ID",a)},e.sortNombre=function(a){e.doSort("NOMBRE_GENERICO",a)},e.sortAdministracion=function(a){e.doSort("UNID_ENT_ID",a)},e.sortEntrega=function(a){e.doSort("UNID_MIN_ID",a)},e.sortFactor=function(a){e.doSort("FACTOR_CONVERSION_ENTREGA",a)},e.sortEstado=function(a){e.doSort("MES_ID",a)},e.doSort=function(a,b){var c=!1;b.target.classList.contains("selected")&&(c=!0),b.target.classList.contains("selected")?b.target.classList.toggle("fa-rotate-180"):($(".grilla thead th i").removeClass("selected"),$(".grilla thead th i").removeClass("fa-rotate-180"),b.target.classList.add("selected")),e.grilla.sort(a,c)},a.toggleFarmaco=function(){!e.grilla.waiting&&e.grilla.insumo.toggle&&(e.grilla.farmaco.toggle?(e.grilla.farmaco.toggle=!1,e.grilla.farmaco.clase="fa fa-square-o"):(e.grilla.farmaco.toggle=!0,e.grilla.farmaco.clase="fa fa-check-square-o"),e.grilla.reload())},a.toggleInsumo=function(){!e.grilla.waiting&&e.grilla.farmaco.toggle&&(e.grilla.insumo.toggle?(e.grilla.insumo.toggle=!1,e.grilla.insumo.clase="fa fa-square-o"):(e.grilla.insumo.toggle=!0,e.grilla.insumo.clase="fa fa-check-square-o"),e.grilla.reload())},e.escogerPendientes=function(){e.escogerEstados(!1)},e.escogerTodas=function(){e.escogerEstados(!0)},e.escogerEstados=function(a){e.grilla.waiting||(e.grilla.estados=a?[]:[1,2,3],e.grilla.esFarmaciaPopular=a,e.grilla.paginaActual=1,e.grilla.reload())},a.showModal=function(a){$(a).foundation("reveal","open")},a.closeModal=function(a){$(a).foundation("reveal","close")},b.getUNI().then(function(a){e.unidades=a.data}),b.getLINE().then(function(a){e.tipoArticulos=a.data}),b.getMES().then(function(a){e.estadoSolicitudes=a.data}),e.grilla.reload(),e.getNombreUnidad=function(a){if(void 0!=e.unidades){var b=e.unidades.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreTipoArticulo=function(a){if(void 0!=e.tipoArticulos){var b=e.tipoArticulos.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreEstado=function(a){if(void 0!=e.estadoSolicitudes){var b=e.estadoSolicitudes.filter(function(b){return b.ID==a});if(b.length>0)return b[0].NOMBRE}return""},e.getPrimerComentario=function(b){return a.getPrimerComentario(b,function(a){return e.getNombrePorId(a)})},e.showHistorial=function(a){e.grilla.showHistorial[a]?e.grilla.showHistorial[a]=!1:e.grilla.showHistorial[a]=!0},e.getActivos=function(a){if(void 0!=a){var b=a.filter(function(a){return 1==a.ACTIVO&&0==a.ELIMINADO});if(b.length>0)return b}return[]},e}angular.module("mantenedorSolicitudInsumo").controller("solicitudInsumoController",a),a.$inject=["$rootScope","dataService","toastr","toastrNoDismiss"]}(),function(){"use strict";function a(a,b){a.state("er.arsenal",{url:"/articulo/arsenal",views:{"container@":{templateUrl:"arsenal/mantenedor.arsenal.view.html",controller:"arsenalController as adm"},"infoBarContainer@":{templateUrl:"arsenal/mantenedor.arsenal.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.CONSULTAR_ARTICULO,titulo:"Arsenal"}})}angular.module("mantenedorArsenal",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;return c.info("Cargando Mantenedor","Mi arsenal"),a.menu={articulo:"active"},a.moduloActivo="arsenal",e.moduleTitle="Mi Arsenal",e.subtitle="",a.cargarIndicadoresIniciales(),e.dataService=b,e.solicitud={titulo:"Solicitar",form:{id:0},procesando:!1,textoValidando:"Validando...",invalido:!1,show:function(a){this.cancelar(),this.articulo=e.grilla.resultado[a],this.rl_bode_arti=null,this.titulo=e.getNombreTipoArticulo(this.articulo.LINE_ID)+": "+this.articulo.NOMBRE_GENERICO,e.minigrilla.resultado=[],b.getBODEGA(e.select.elegido.ID).then(function(a){if(a.data.length>0){var c=a.data[0].ID;b.getRL_BODEGA(c,e.solicitud.articulo.ID).then(function(a){a.data.length>0&&(e.solicitud.rl_bode_arti=a.data[0])})}}),e.minigrilla.artiId=this.articulo.ID,e.minigrilla.reload(),$("#detalleArticulo").foundation("reveal","open")},continuar:function(){return""==e.minigrilla.searchTerms||e.minigrilla.waiting?!1:void(e.solicitud.paso=2)},buscarSimilares:function(a){return void 0!=a&&13!=a.keyCode?!1:""==e.minigrilla.searchTerms?(e.solicitud.requerido.buscado=!0,!1):(e.solicitud.mostrarPregunta=!0,e.solicitud.requerido.buscado=!1,this.form.nombre=e.minigrilla.searchTerms,e.minigrilla.oculto=!1,void e.minigrilla.reload())},cancelar:function(){a.closeModal("#detalleArticulo"),this.form.id="",this.invalido=!1,this.procesando=!1,e.minigrilla.paginaActual=1;
},validar:function(){var a=!0;return this.invalido=!1,(this.articulo.STOCK>0||this.articulo.CANTIDAD_DE_RECETAS>0)&&(this.invalido=!0,a=!1),a?!0:!1},pasivar:function(a){if(e.solicitud.procesando=!0,e.solicitud.textoProcesando="Validando...",!this.validar())return void(e.solicitud.procesando=!1);e.solicitud.textoProcesando="Procesando solicitud...";var d=angular.copy(e.solicitud.rl_bode_arti);d.ELIMINADO=1,b.putRL_BODEGA(d).then(function(a){null!=a.data&&1==a.data.ELIMINADO&&(c.success("Artículo pasivado con éxito","Pasivar Artículo"),e.solicitud.cancelar(),e.grilla.reload())})["catch"](function(a){c.error("No se pudo eliminar el artículo del arsenal, al parecer fue modificado por otro usuario","Pasivar Artículo"),e.solicitud.procesando=!1})}},e.grilla=new a.NeoGrilla(b),e.grilla.esFarmaciaPopular=!1,e.grilla.callback.getData=function(){var a="todos";e.grilla.farmaco.toggle&&!e.grilla.insumo.toggle&&(a="farmaco"),!e.grilla.farmaco.toggle&&e.grilla.insumo.toggle&&(a="insumo"),e.grilla.ds.getARSENAL(e.grilla.establecimientoId,e.grilla.mostrando,e.grilla.paginaActual,e.grilla.orden,e.grilla.ordenDireccion,e.grilla.searchTerms.length>3?e.grilla.searchTerms:"",a,e.grilla.esFarmaciaPopular).then(function(a){for(var b=0;b<a.data.length;b++)a.data[b].NEO_ID=a.data[b].ID+"-"+a.data[b].BODE_ID;e.grilla.resultado=a.data,e.grilla.finishReload()})["catch"](function(a){e.grilla.onError(a)})},e.grilla.callback.getCountPaginacion=function(){var a="todos";e.grilla.farmaco.toggle&&!e.grilla.insumo.toggle&&(a="farmaco"),!e.grilla.farmaco.toggle&&e.grilla.insumo.toggle&&(a="insumo"),e.grilla.ds.countARSENAL(e.grilla.establecimientoId,e.grilla.searchTerms.length>3?e.grilla.searchTerms:"",a,e.grilla.esFarmaciaPopular).then(function(a){var b={data:new Array(a.data.CANTIDAD)};e.grilla.finishPaginacion(b)})},e.grilla.waiting=!1,e.minigrilla=new a.NeoGrilla(b),e.minigrilla.largo=4,e.minigrilla.mostrando=5,e.minigrilla.waiting=!1,e.minigrilla.active=!0,e.minigrilla.callback.getData=function(){b.getArtiById(e.minigrilla.artiId).then(function(a){return a.data.ARTI_ID?void e.minigrilla.ds.getRECETA(e.grilla.establecimientoId,a.data.ARTI_ID,e.minigrilla.mostrando,e.minigrilla.paginaActual).then(function(a){e.minigrilla.resultado=a.data,e.minigrilla.finishReload()})["catch"](function(a){e.minigrilla.onError(a)}):void e.minigrilla.finishReload()})["catch"](function(a){e.minigrilla.onError(a)})},e.minigrilla.callback.getCountPaginacion=function(){b.getArtiById(e.minigrilla.artiId).then(function(a){b.countRECETA(e.grilla.establecimientoId,a.data.ARTI_ID).then(function(a){var b={data:new Array(a.data.CANTIDAD)};e.minigrilla.finishPaginacion(b)})})},e.modal={articulo:null,titulo:"",detalle:{show:function(a){this.articulo=e.grilla.resultado[a],e.modal.articulo=e.grilla.resultado[a],this.titulo=e.getNombreTipoArticulo(this.articulo.LINE_ID)+": "+this.articulo.NOMBRE_GENERICO,e.minigrilla.artiId=this.articulo.ID,e.minigrilla.reload(),$("#detalleArticulo").foundation("reveal","open")}},checked:function(a){return"1"==a||1==a?"checked":""}},e.solicitarArticulo=function(b){e.solicitud.titulo="Revise su solicitud de Nuevo Artículo",e.solicitud.dataOriginal=e.grilla.resultado[b],e.solicitud.historial=e.grilla.historial[b],e.solicitud.index=b,e.solicitud.form.id=e.grilla.resultado[b].ID,e.solicitud.form.tipo=e.grilla.resultado[b].LINE_ID,e.solicitud.form.nombre=e.grilla.resultado[b].NOMBRE_GENERICO,e.solicitud.form.codigoIsp=e.grilla.resultado[b].CODIGO_ISP,e.solicitud.form.uAdministracion=""+e.grilla.resultado[b].UNID_MIN_ID,e.solicitud.form.uEntrega=""+e.grilla.resultado[b].UNID_ENT_ID,e.solicitud.form.factor=e.grilla.resultado[b].FACTOR_CONVERSION,a.showModal("#formularioSolicitud")},e.show=function(a){2==e.grilla.resultado[a].MES_ID?e.solicitarArticulo(a):e.modal.detalle.show(a)},e.sortId=function(a){e.doSort("ID",a)},e.sortTipo=function(a){e.doSort("LINE_ID",a)},e.sortNombre=function(a){e.doSort("NOMBRE_GENERICO",a)},e.sortStock=function(a){e.doSort("STOCK",a)},e.sortReceta=function(a){e.doSort("CANTIDAD_DE_RECETAS",a)},e.doSort=function(a,b){var c=!1;b.target.classList.contains("selected")&&(c=!0),b.target.classList.contains("selected")?b.target.classList.toggle("fa-rotate-180"):($(".grilla thead th i").removeClass("selected"),$(".grilla thead th i").removeClass("fa-rotate-180"),b.target.classList.add("selected")),e.grilla.sort(a,c)},a.toggleFarmaco=function(){!e.grilla.waiting&&e.grilla.insumo.toggle&&(e.grilla.farmaco.toggle?(e.grilla.farmaco.toggle=!1,e.grilla.farmaco.clase="fa fa-square-o"):(e.grilla.farmaco.toggle=!0,e.grilla.farmaco.clase="fa fa-check-square-o"),e.grilla.reload())},a.toggleInsumo=function(){!e.grilla.waiting&&e.grilla.farmaco.toggle&&(e.grilla.insumo.toggle?(e.grilla.insumo.toggle=!1,e.grilla.insumo.clase="fa fa-square-o"):(e.grilla.insumo.toggle=!0,e.grilla.insumo.clase="fa fa-check-square-o"),e.grilla.reload())},e.escogerRayen=function(){e.escogerTipoFarmacia(!1)},e.escogerPopular=function(){e.escogerTipoFarmacia(!0)},e.escogerTipoFarmacia=function(a){e.grilla.waiting||(e.grilla.esFarmaciaPopular=a,e.grilla.reload())},a.showModal=function(a){$(a).foundation("reveal","open")},a.closeModal=function(a){$(a).foundation("reveal","close")},b.getUNI().then(function(a){e.unidades=a.data}),b.getLINE().then(function(a){e.tipoArticulos=a.data}),b.getMES().then(function(a){e.estadoSolicitudes=a.data}),e.getNombreUnidad=function(a){if(void 0!=e.unidades){var b=e.unidades.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreTipoArticulo=function(a){if(void 0!=e.tipoArticulos){var b=e.tipoArticulos.filter(function(b){return b.ID==a});if(b.length>0)return b[0].DESCRIPCION}return""},e.getNombreEstado=function(a){if(void 0!=e.estadoSolicitudes){var b=e.estadoSolicitudes.filter(function(b){return b.ID==a});if(b.length>0)return b[0].NOMBRE}return""},e.getPrimerComentario=function(a){if(void 0==a||0==a.length)return"";var b=e.getActivos(a);return void 0==b||0==b.length?"":"["+b[0].FECHA_CREACION+"]"+b[0].COMENTARIO},e.showHistorial=function(a){e.grilla.showHistorial[a]?e.grilla.showHistorial[a]=!1:e.grilla.showHistorial[a]=!0},e.getActivos=function(a){if(void 0!=a){var b=a.filter(function(a){return 1==a.ACTIVO&&0==a.ELIMINADO});if(b.length>0)return b}return[]},e.pressEnterSearch=function(a){13==a.keyCode&&e.grilla.reload()},e.select=new a.NeoSelect,e.select.callbacks.seleccionado=function(a,b){b&&(e.grilla.paginaActual=1,e.grilla.establecimientoId=a,c.info("Cargando datos para "+e.select.elegido.DESCRIPCION,"Cargando..."),e.grilla.active=!0,e.grilla.reload())},e.select.cargar(),e}angular.module("mantenedorArsenal").controller("arsenalController",a),a.$inject=["$rootScope","dataService","toastr","toastrNoDismiss"]}(),function(){"use strict";function a(a,b){a.state("er.receta",{url:"/receta",views:{"container@":{templateUrl:"receta/mantenedor.receta.view.html",controller:"recipeController as adm"},"infoBarContainer@":{templateUrl:"receta/mantenedor.receta.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.LISTAR_RECETA,titulo:"Recetas"}})}angular.module("mantenedorRecipe",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;return c.info("Iniciando Mantenedor de Tipo de Recetas","Recetas"),a.reset=function(a){a&&(a.$setPristine(),a.$setUntouched())},a.reset(),a.moduleTitle="Tipos de Receta",a.showModal=function(a){$(a).foundation("reveal","open")},a.closeModal=function(a){$(a).foundation("reveal","close")},a.esconderBotonera=function(a){$("#botonera-id-"+a+" .botonera-no-edicion").show(),$("#botonera-id-"+a+" .botonera-edicion").hide(),$("#data-id-"+a+" td .data").show(),$("#data-id-"+a+" td .edit").hide()},a.editData=function(a,b){null!=this.receta&&(this.receta.periodicidad=e.grilla.resultado[a].PERIODICIDAD_DIAS,this.receta.vigencia=e.grilla.resultado[a].VIGENCIA_DIAS),$("#botonera-id-"+b+" .botonera-no-edicion").hide(),$("#botonera-id-"+b+" .botonera-edicion").show(),$("#data-id-"+b+" td .data").hide(),$("#data-id-"+b+" td .edit").show()},a.cancelEdit=function(a){$("#botonera-id-"+a+" .botonera-no-edicion").show(),$("#botonera-id-"+a+" .botonera-edicion").hide(),$("#data-id-"+a+" td .data").show(),$("#data-id-"+a+" td .edit").hide()},a.saveData=function(a){e.actualizarTipoReceta(a,this.receta)},e.disableEnter=function(a){return 13==a.keyCode?void a.preventDefault():void 0},a.popupDelete=function(b){e.payloadBorrar=b,a.showModal("#confirmaEliminacion")},a.deleteData=function(){e.eliminarTipoReceta(),a.closeModal("#confirmaEliminacion")},e.eliminarTipoReceta=function(){return void 0==e.payloadBorrar||null==e.payloadBorrar?void c.error("No se pudo eliminar el tipo receta para el nodo","Error"):68==e.payloadBorrar.TREC_ID?void c.error('No se puede eliminar el tipo receta "'+a.getNombreReceta(e.payloadBorrar.TREC_ID)+'"',"Error"):(c.info("Eliminando tipo receta para el nodo...","Información"),void b.deleteRL_TREC_NOD(e.payloadBorrar).then(function(a){c.success("Tipo receta eliminado con éxito","Éxito"),e.grilla.reload()},function(a){c.error("Ocurrió un problema al eliminar","Error")}))},e.solicitud={form:{},requerido:{},reiniciar:function(){this.waiting=!0,this.form={tipo:"",periodicidad:"",vigencia:""},this.requerido={tipo:!1,periodicidad:!1,vigencia:!1,vigenciaMenor:!1}},abrir:function(){e.grilla.establecimientoId>0?(e.solicitud.reiniciar(),e.trecOcupado=!1,a.showModal("#asociarReceta")):c.error("Seleccione un establecimiento antes de continuar","Aviso")},validar:function(){this.requerido.tipo=!1,this.requerido.periodicidad=!1,this.requerido.vigencia=!1,this.requerido.vigenciaMenor=!1;var a=!0;return 0==this.form.tipo.trim().length&&(this.requerido.tipo=!0,a=!1),0==this.form.periodicidad.trim().length&&(this.requerido.periodicidad=!0,a=!1),0==this.form.vigencia.trim().length&&(this.requerido.vigencia=!0,a=!1),null!=this.form.vigencia&&null!=this.form.periodicidad&&parseInt(this.form.vigencia)<=parseInt(this.form.periodicidad)&&(this.requerido.vigenciaMenor=!0,a=!1),a||c.warning("Existen errores en el formulario, revise","Aviso"),a},insert:function(){if(this.validar()){if(e.trecOcupado)return c.warning("No puede registrar un tipo de receta ya existente","Aviso"),!1;var d={TREC_ID:parseInt(e.solicitud.form.tipo),NOD_ID:parseInt(e.grilla.establecimientoId),PERIODICIDAD_DIAS:parseInt(e.solicitud.form.periodicidad),VIGENCIA_DIAS:parseInt(e.solicitud.form.vigencia),NOD_NODO:null,TREC_TIPO_RECETA:null};c.info("Creando tipo receta para este nodo...","Información"),b.postRL_TREC_NOD(d).then(function(b){a.closeModal("#asociarReceta"),c.success("Creación exitosa!","Éxito"),e.grilla.reload(),e.solicitud.reiniciar()},function(a){c.error("Ocurrió un problema al crear","Error")})}}},e.solicitud.reiniciar(),e.procesandoSave=!1,e.actualizarTipoReceta=function(a,d){if(e.procesandoSave=!0,void 0==d.periodicidad||void 0==d.vigencia)return c.warning("Revise sus entradas, no se cumple con los campos requeridos","Aviso"),void(e.procesandoSave=!1);if(d.periodicidad<0||d.vigencia<0)return c.warning("Periodicidad y Vigencia deben ser mayores a 0","Aviso"),void(e.procesandoSave=!1);if(d.vigencia<=d.periodicidad)return c.warning("Vigencia debe ser mayor a Periodicidad","Aviso"),void(e.procesandoSave=!1);var f=void 0;if(e.grilla.resultado.constructor===Array)for(var g=0;g<e.grilla.resultado.length;g++){var h=e.grilla.resultado[g];if(h.NOD_ID==e.select.elegido.ID&&h.TREC_ID==a){f=h;break}}return void 0==f?void c.error("No se puede encontrar esta relación","Error"):(f.PERIODICIDAD_DIAS=d.periodicidad,f.VIGENCIA_DIAS=d.vigencia,c.info("Actualizando tipo receta...","Información"),void b.putRL_TREC_NOD(f).then(function(a){c.success("Actualización exitosa!","Éxito"),e.grilla.reload()},function(a){c.error("Ocurrió un problema al actualizar","Error")}))},e.trecOcupado=!1,e.revisarExistencia=function(){b.getTRECPorID(e.solicitud.form.tipo).then(function(a){if(a.data.constructor===Array&&(e.trecLeido=a.data[0],e.trecLeido.RL_TREC_NOD.constructor===Array))for(var b=0;b<e.trecLeido.RL_TREC_NOD.length;b++)if(e.trecLeido.RL_TREC_NOD[b].NOD_ID==e.grilla.establecimientoId)return void(e.trecOcupado=!0);e.trecOcupado=!1})},e.grilla=new a.NeoGrilla(b),e.grilla.active=!1,e.grilla.waiting=!1,e.grilla.orden="NOMBRE",e.grilla.callback.getData=function(){e.grilla.ds.getNodoTREC(e.grilla.establecimientoId,100,1).then(function(b){e.select.tiposRecetaFiltrado=e.obtenerNodosFormulario(b.data);var c=b.data.filter(function(b){return a.getNombreReceta(b.TREC_ID).toLowerCase().includes(e.grilla.searchTerms.toLowerCase())});c=e.orderByAttr(c,e.grilla.orden,e.grilla.ordenDireccion);var d=(e.grilla.paginaActual-1)*e.grilla.mostrando;e.grilla.resultado=c.slice(d,d+e.grilla.mostrando),e.grilla.finishReload(),e.procesandoSave=!1})},e.grilla.callback.getCountPaginacion=function(){e.grilla.ds.getCountTREC(e.grilla.establecimientoId,e.grilla.mostrando,e.grilla.paginaActual).then(function(b){var c=b.data.filter(function(b){return a.getNombreReceta(b.TREC_ID).toLowerCase().includes(e.grilla.searchTerms.toLowerCase())}),d={data:c};e.grilla.finishPaginacion(d)})},e.sortPeriodicidad=function(a){e.grilla.doSort("PERIODICIDAD_DIAS",a)},e.sortVigencia=function(a){e.grilla.doSort("VIGENCIA_DIAS",a)},e.sortNombre=function(a){e.grilla.doSort("NOMBRE",a)},e.select=new a.NeoSelect,e.select.callbacks.seleccionado=function(a,b){b&&(e.grilla.paginaActual=1,e.grilla.establecimientoId=a,c.info("Cargando datos para "+e.select.elegido.DESCRIPCION,"Cargando..."),e.grilla.active=!0,e.grilla.reload())},e.select.cargar(),e.obtenerNodosFormulario=function(b){for(var c=[],d=0;d<a.tiposGlobales.tiposDeReceta.length;d++){for(var e=!0,f=0;f<b.length;f++)a.tiposGlobales.tiposDeReceta[d].ID==b[f].TREC_ID&&(e=!1);e&&c.push(a.tiposGlobales.tiposDeReceta[d])}return c},e.orderByAttr=function(b,c,d){if(!angular.isObject(b))return b;var e=[];for(var f in b)e.push(b[f]);return e.sort(function(b,e){return"NOMBRE"!=c?(b=parseInt(b[c]),e=parseInt(e[c]),"asc"==d?b-e:e-b):(b=a.getNombreReceta(b.TREC_ID),e=a.getNombreReceta(e.TREC_ID),"asc"==d?b.localeCompare(e):e.localeCompare(b))}),e},e}angular.module("mantenedorRecipe").controller("recipeController",a),a.$inject=["$rootScope","dataService","toastr","toastrNoDismiss"]}(),angular.module("mantenedorRecipe").directive("numbersOnly",function(){return{require:"ngModel",link:function(a,b,c,d){function e(a){if(a){var b=a.toString().replace(/[^0-9]/g,"");return b!==a&&(d.$setViewValue(b),d.$render()),b}return void 0}d.$parsers.push(e)}}}),function(){"use strict";function a(a,b){a.state("er.consulta",{url:"/consulta",views:{"container@":{templateUrl:"consulta/mantenedor.consulta.view.html",controller:"consultaController as adm"},"infoBarContainer@":{templateUrl:"consulta/mantenedor.consulta.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.LISTAR_TIPOS_CONSULTA,titulo:"Consultas"}})}angular.module("mantenedorConsulta",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"]}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;return a.moduleTitle="Tipos de Consulta",e.getDescripcion=function(a){var b=[];return b[1]="Sin información",b[2]="Sin información",b[3]="Sin información",b[4]="Sin información",b[5]="Sin información",b[6]="Sin información",b[7]="Sin información",b[8]="Sin información",b[9]="Sin información",b[10]="Sin información",b[11]="Sin información",b[12]="N/A",a>0?b[a]:""},e.editar={active:!1,select:{cardinalidad:[{id:0,valor:"Individual"},{id:1,valor:"Grupal"},{id:2,valor:"Comunitaria"}]},reset:function(){this.procesando=!1,this.textoProcesando="",this.form={nombre:"",duracion:"",espontaneo:!1,morbilidad:!1,sms:!1,cardinalidad:this.select.cardinalidad[0],clasificacion:this.select.clasificacion[0],rem:this.select.rems[0]},this.bloqueo={cardinalidad:!1},this.validacion={nombre:!1,nombreDuplicado:!1,duracion:!1,espontaneo:!1,morbilidad:!1,sms:!1},this.bag={clasificacionDesc:""}},show:function(){a.showModal("#asociarConsulta")},close:function(){a.closeModal("#asociarConsulta")},crear:function(){this.active&&(this.reset(),this.esEdicion=!1,this.textoBoton="Guardar",this.textoTitulo="Crear Tipo de Consulta",this.show())},editar:function(a){this.reset(),this.esEdicion=!0,this.textoBoton="Guardar",this.textoTitulo="Modificar Tipo de Consulta",this.bloqueo.cardinalidad=!0,this.objetoEditando=angular.copy(a.dataOriginal),this.form={nombre:a.nombre,duracion:a.duracion,espontaneo:a.espontaneo?!0:!1,morbilidad:a.morbilidad?!0:!1,sms:a.sms?!0:!1,cardinalidad:this.getCardinalidad(a.cardinalidad),clasificacion:this.getClasificacion(a.CTDA_CLASIFIACION_TIPO_ATENCION.ID),rem:this.getRem(a.extra.rems)},this.showDescripcion(),this.show()},getRem:function(a){var b=e.getRemActivo(a);if(null!=b){var c=this.select.rems.filter(function(a){return a.Id==b.TDGA_ID});return c.length>0?c[0]:this.select.rems.filter(function(a){return 0==a.Id})[0]}return this.select.rems.filter(function(a){return 0==a.Id})[0]},validar:function(){this.validacion={nombre:!1,nombreDuplicado:!1,duracion:!1,espontaneo:!1,morbilidad:!1,sms:!1};var a=!0;return""==this.form.nombre&&(this.validacion.nombre=!0,a=!1),this.form.duracion&&""!=this.form.duracion||(this.validacion.duracion=!0,a=!1),a},guardar:function(a){if(!this.procesando){if(this.procesando=!0,this.textoProcesando="Validando...",!this.validar())return this.procesando=!1,this.textoProcesando="",void c.warning("Existen errores en el formulario","Error");if(a){var d={nodId:e.select.elegido.ID,nombre:e.editar.form.nombre,duracion:e.editar.form.duracion,cardinalidad:e.editar.form.cardinalidad.id,espontaneo:e.editar.form.espontaneo?1:0,morbilidad:e.editar.form.morbilidad?1:0,sms:e.editar.form.sms?1:0,clasificacion:e.editar.form.clasificacion.ID};b.getTDA(e.grilla.establecimientoId,100,1,e.grilla.orden,e.grilla.ordenDireccion,e.editar.form.nombre).then(function(a){if(a.data.length>0)for(var f=0;f<a.data.length;f++)if(a.data[f].NOMBRE.toUpperCase()==e.editar.form.nombre.toUpperCase())return c.warning("El nombre indicado ya existe para el establecimiento, revise por favor","Error"),e.editar.procesando=!1,e.editar.textoProcesando="",void(e.editar.validacion.nombreDuplicado=!0);b.postTDA(d).then(function(a){if(0==e.rems.length)return e.editar.close(),c.success("Tipo de Consulta actualizado correctamente","Éxito"),void e.grilla.reload();e.editar.bag.waitingRems=[];for(var d=0;d<e.rems.length;d++)e.editar.bag.waitingRems[d]=!0;for(var d=0;d<e.rems.length;d++){var f={CTDA_ID:a.data.ID,TDGA_ID:e.rems[d].Id,ELIMINADO:e.rems[d].Id==e.editar.form.rem.Id?0:1};b.postTdaRem(f,d).then(function(a){e.editar.bag.waitingRems[a.config.input.position]=!1,e.editar.revisarWaitingRems(function(){e.editar.close(),c.success("Tipo de Consulta creado correctamente","Éxito"),e.grilla.reload()})})["catch"](function(a){b.getTDAByNombre(e.grilla.establecimientoId,e.editar.form.nombre).then(function(a){for(var b=0;b<e.editar.bag.waitingRems.length;b++)e.editar.bag.waitingRems[b]=!1;e.editar.revisarWaitingRems(function(){e.editar.close(),c.success("Tipo de Consulta creado correctamente","Éxito"),e.grilla.reload()})})["catch"](function(a){for(var b=0;b<e.editar.bag.waitingRems.length;b++)e.editar.bag.waitingRems[b]=!1;e.editar.revisarWaitingRems(function(){e.editar.close(),c.warning("No se pudo validar la creación del Tipo de Consulta, favor valide",""),e.grilla.reload()})})})}})["catch"](function(a){c.error("Ocurrio un problema al crear","Error"),e.editar.procesando=!1})})["catch"](function(a){c.error("Ocurrio un problema al validar el nombre, por favor revise","Error"),e.editar.procesando=!1,e.editar.textoProcesando=""})}else this.objetoEditando.NOMBRE=this.form.nombre,this.objetoEditando.DURACION_SUGERIDA=this.form.duracion,this.objetoEditando.CTDA_ID=this.form.clasificacion.ID,this.objetoEditando.ESESPONTANEO=this.form.espontaneo?1:0,this.objetoEditando.MORBILIDAD=this.form.morbilidad?1:0,this.objetoEditando.ENVIAR_MENSAJERIA_CORTA=this.form.sms?1:0,b.getTDA(e.grilla.establecimientoId,1,1,e.grilla.orden,e.grilla.ordenDireccion,this.form.nombre).then(function(a){if(a.data.length>0)for(var d=0;d<a.data.length;d++)if(a.data[d].NOMBRE==e.editar.form.nombre&&a.data[d].ID!=e.editar.objetoEditando.ID)return c.warning("El nombre indicado ya existe para el establecimiento, revise por favor","Error"),e.editar.procesando=!1,e.editar.textoProcesando="",void(e.editar.validacion.nombreDuplicado=!0);b.putTDA(e.editar.objetoEditando).then(function(a){c.info("Actualizando REMS","Información");var d=e.editar.form.rem.Id;if(e.editar.bag.waitingRems=[],0==e.rems.length)return e.editar.close(),c.success("Tipo de Consulta actualizado correctamente","Éxito"),void e.grilla.reload();for(var f=0;f<e.rems.length;f++)e.editar.bag.waitingRems[f]=!0;for(var f=0;f<e.rems.length;f++){var g={CTDA_ID:e.editar.objetoEditando.ID,TDGA_ID:e.rems[f].Id,ELIMINADO:e.rems[f].Id==d?0:1};b.putTdaRem(g,f).then(function(a){e.editar.bag.waitingRems[a.config.input.position]=!1,e.editar.revisarWaitingRems(function(){e.editar.close(),c.success("Tipo de Consulta actualizado correctamente","Éxito"),e.grilla.reload()})})["catch"](function(a){c.success("Tipo de Consulta actualizado","Éxito"),e.editar.close(),e.grilla.reload(),e.editar.textoProcesando=""})}})["catch"](function(a){c.error("Ocurrio un problema al actualizar","Error"),e.editar.procesando=!1,e.editar.textoProcesando=""})})["catch"](function(a){c.error("Ocurrio un problema al validar el nombre, por favor revise","Error"),e.editar.procesando=!1,e.editar.textoProcesando=""})}},actualizar:function(){this.guardar(!1)},solicitar:function(){this.guardar(!0)},revisarWaitingRems:function(a){for(var b=!0,c=0;c<this.bag.waitingRems.length;c++)this.bag.waitingRems[c]&&(b=!1);b&&a()},showDescripcion:function(){this.bag.clasificacionDesc=e.getDescripcion(this.form.clasificacion.ID)},getClasificacion:function(a){var b=this.select.clasificacion.filter(function(b){return b.ID==a});return b.length>0?b[0]:""},getCardinalidad:function(a){var b=this.select.cardinalidad.filter(function(b){return b.id==a});return b.length>0?b[0]:""}},b.getCTDA().then(function(a){for(var b=0;b<a.data.length;b++)a.data[b].DESCRIPCION=a.data[b].NOMBRE;e.select.clasificaciones=a.data,e.editar.select.clasificacion=a.data}),b.getREM().then(function(b){e.rems=angular.copy(b.data),b.data=a.joinArrays(b.data,[{Id:0,Descripcion:"Ninguno"}]),b.data=a.orderByAttr(b.data,"Id","int","asc"),e.select.rems=b.data,e.editar.select.rems=b.data}),a.showModal=function(a){$(a).foundation("reveal","open")},a.closeModal=function(a){$(a).foundation("reveal","close")},a.popupDelete=function(b,c){e.payloadBorrar=b,e.payloadBorrar.index=c,e.modalEliminacion.procesando=!1,a.showModal("#confirmaEliminacion")},a.deleteData=function(){e.eliminarTipoAtencion()},e.eliminarTipoAtencion=function(){return void 0==e.payloadBorrar||null==e.payloadBorrar?void c.error("No se pudo eliminar el tipo de atención para el nodo","Error"):(e.modalEliminacion.cantidadCitas=0,e.modalEliminacion.cantidadSegmentos=0,e.modalEliminacion.procesando=!0,e.modalEliminacion.paso=1,e.modalEliminacion.waiting.cita=!0,e.modalEliminacion.waiting.segmento=!0,e.modalEliminacion.valido=!0,b.getCITA(e.grilla.establecimientoId,e.payloadBorrar.id,500,1).then(function(b){e.modalEliminacion.waiting.cita=!1,b.data.length>0&&(e.grilla.waiting=!1,e.modalEliminacion.valido=!1,e.modalEliminacion.cantidadCitas=b.data.length,c.error("No se puede eliminar un Tipo de Atención con citas futuras","Error"),a.showModal("#errorEliminacion")),e.modalEliminacion.validar()})["catch"](function(a){c.error("No se puede consultar las citas, por favor vuelva a intentar","Error")}),void b.getSGH(e.grilla.establecimientoId,e.payloadBorrar.id,500,1).then(function(b){e.modalEliminacion.waiting.segmento=!1,b.data.length>0&&(e.grilla.waiting=!1,e.modalEliminacion.valido=!1,e.modalEliminacion.cantidadSegmentos=b.data.length,c.error("No se puede eliminar un Tipo de Atención con segmentos asignados","Error"),a.showModal("#errorEliminacion")),e.modalEliminacion.validar()})["catch"](function(a){c.error("No se puede consultar los segmentos, por favor vuelva a intentar","Error")}))},e.modalEliminacion={paso:1,waiting:{cita:!0,segmento:!0},verPaso1:function(){this.paso=1},verCitas:function(){e.miniGrillaCita.reload(),this.paso=2},verSegmentos:function(){e.miniGrillaSegmento.reload(),this.paso=3},validar:function(){if(!this.waiting.cita&&!this.waiting.segmento&&e.modalEliminacion.valido){e.grilla.waiting=!0;var d=e.grilla.resultadoOriginal[e.payloadBorrar.index].dataOriginal;d.ACTIVO=0,b.putTDA(d).then(function(b){e.modalEliminacion.procesando=!1,a.closeModal("#confirmaEliminacion"),c.success("Tipo de atención eliminado con éxito","Éxito"),e.grilla.reload()})["catch"](function(b){e.modalEliminacion.procesando=!1,a.closeModal("#confirmaEliminacion"),e.grilla.reload(),c.error("Ocurrió un problema al eliminar","Error")})}}},e.miniGrillaCita=new a.NeoGrilla(b),e.miniGrillaCita.active=!0,e.miniGrillaCita.waiting=!0,e.miniGrillaCita.largo=4,e.miniGrillaCita.mostrando=5,e.miniGrillaCita.callback.getData=function(){b.getCITA(e.grilla.establecimientoId,e.payloadBorrar.id,e.miniGrillaCita.mostrando,e.miniGrillaCita.paginaActual).then(function(a){e.miniGrillaCita.bag=a.data,e.miniGrillaCita.ejecutados=a.data.length;for(var b=0;b<e.miniGrillaCita.bag.length;b++)e.miniGrillaCita.bag[b].NOMBRE="",e.miniGrillaCita.callback.getNombreFuncionario(a.data[b].FNP_ID);0==a.data.length&&(e.miniGrillaCita.resultado=a.data,e.miniGrillaCita.finishReload())})},e.miniGrillaCita.callback.getNombreFuncionario=function(a){b.getFNP(a).then(function(a){var b=e.miniGrillaCita.bag.filter(function(b){return b.FNP_ID=a.config.input.idFuncionario});b.length>0&&a.data&&(b[0].NOMBRE=a.data.NOMBRES+" "+a.data.APELLIDO_PATERNO+" "+a.data.APELLIDO_MATERNO),e.miniGrillaCita.ejecutados--,e.miniGrillaCita.callback.revisarWaitingList()})["catch"](function(a){e.miniGrillaCita.ejecutados--,e.miniGrillaCita.callback.revisarWaitingList()})},e.miniGrillaCita.callback.revisarWaitingList=function(){0==e.miniGrillaCita.ejecutados&&(e.miniGrillaCita.resultado=e.miniGrillaCita.bag,e.miniGrillaCita.finishReload())},e.miniGrillaCita.callback.getCountPaginacion=function(){b.getCITA(e.grilla.establecimientoId,e.payloadBorrar.id,500,1).then(function(a){e.miniGrillaCita.finishPaginacion(a)})},e.miniGrillaSegmento=new a.NeoGrilla(b),e.miniGrillaSegmento.active=!0,e.miniGrillaSegmento.waiting=!0,e.miniGrillaSegmento.largo=3,e.miniGrillaSegmento.mostrando=5,e.miniGrillaSegmento.callback.getData=function(){b.getSGH(e.grilla.establecimientoId,e.payloadBorrar.id,e.miniGrillaSegmento.mostrando,e.miniGrillaSegmento.paginaActual).then(function(a){e.miniGrillaSegmento.bag=a.data,e.miniGrillaSegmento.ejecutados=a.data.length;for(var b=0;b<e.miniGrillaSegmento.bag.length;b++)e.miniGrillaSegmento.bag[b].NOMBRE="",e.miniGrillaSegmento.callback.getNombreTda(e.miniGrillaSegmento.bag[b].TDA_ID);0==a.data.length&&(e.miniGrillaSegmento.resultado=a.data,e.miniGrillaSegmento.finishReload())})},e.miniGrillaSegmento.callback.getNombreTda=function(a){b.getClasificacionTDA(a).then(function(a){for(var b=0;b<e.miniGrillaSegmento.bag.length;b++)e.miniGrillaSegmento.bag[b].TDA_ID==a.config.input.idTda&&(e.miniGrillaSegmento.bag[b].NOMBRE=a.data[0].NOMBRE);e.miniGrillaSegmento.ejecutados--,e.miniGrillaSegmento.callback.revisarWaitingList()})["catch"](function(a){e.miniGrillaSegmento.ejecutados--,e.miniGrillaSegmento.callback.revisarWaitingList()})},e.miniGrillaSegmento.callback.revisarWaitingList=function(){0==e.miniGrillaSegmento.ejecutados&&(e.miniGrillaSegmento.resultado=e.miniGrillaSegmento.bag,e.miniGrillaSegmento.finishReload())},e.miniGrillaSegmento.callback.getCountPaginacion=function(){b.getSGH(e.grilla.establecimientoId,e.payloadBorrar.id,500,1).then(function(a){e.miniGrillaSegmento.finishPaginacion(a)})},e.grilla=new a.NeoGrilla(b),e.grilla.active=!1,e.grilla.waiting=!1,e.grilla.largo=8,e.grilla.orden="NOMBRE",e.grilla.callback.getData=function(){e.grilla.ds.getTDA(e.grilla.establecimientoId,e.grilla.mostrando,e.grilla.paginaActual,e.grilla.orden,e.grilla.ordenDireccion,e.grilla.searchTerms.length<4&&e.grilla.searchTerms.length>0?"":e.grilla.searchTerms).then(function(a){e.grilla.bag={},e.grilla.bag.resultado=a.data,e.grilla.resultadoOriginal=a.data;for(var b=[],c=0;c<a.data.length;c++)b.push(a.data[c].ID),a.data[c].dataOriginal=angular.copy(a.data[c]),a.data[c].extra={rems:[]},a.data[c].revisado=!1;var d=10,f=Math.ceil(b.length/d),g=b;if(f>0)for(var c=0;f>c;c++)g=b.slice(d*c,d*c+d),e.obtenerResultadosGrilla(g);else e.obtenerResultadosGrilla(g)})},e.obtenerResultadosGrilla=function(a){e.grilla.ds.getTdaRem(a).then(function(a){for(var b=a.config.data.split(","),c=0;c<b.length;c++){var d=e.grilla.bag.resultado.filter(function(a){return a.ID==b[c]});if(d.length>0){var f=a.data.filter(function(a){return a.CTDA_ID==d[0].ID});f.length>0&&(d[0].extra={rems:f}),d[0].id=d[0].ID,d[0].nombre=d[0].NOMBRE,d[0].clasificacion=d[0].CTDA_CLASIFIACION_TIPO_ATENCION.NOMBRE,d[0].duracion=d[0].DURACION_SUGERIDA,d[0].cardinalidad=d[0].CARDINALIDAD,d[0].espontaneo=d[0].ESESPONTANEO,d[0].morbilidad=d[0].morbilidad,d[0].sms=d[0].ENVIAR_MENSAJERIA_CORTA,d[0].rem="",d[0].TDA_TIPO_ATENCION=d[0];var g=e.getRemActivo(d[0].extra.rems);null!=g&&(d[0].rem=e.getNombreRem(g.TDGA_ID)),d[0].revisado=!0}}e.finalizarGrilla()})},e.finalizarGrilla=function(){for(var a=!0,b=0;b<e.grilla.bag.resultado.length;b++)if(!e.grilla.bag.resultado[b].revisado){a=!1;break}a&&(e.grilla.resultado=e.grilla.bag.resultado,e.grilla.finishReload())},e.grilla.callback.getCountPaginacion=function(){e.grilla.ds.getCountTDA(e.grilla.establecimientoId,e.grilla.mostrando,e.grilla.paginaActual).then(function(a){var b=a.data.filter(function(a){return a.NOMBRE.toLowerCase().includes(e.grilla.searchTerms.toLowerCase())}),c={data:b};e.grilla.finishPaginacion(c)})},e.sortSMS=function(a){e.grilla.doSort("ENVIAR_MENSAJERIA_CORTA",a)},e.sortMorbilidad=function(a){e.grilla.doSort("morbilidad",a)},e.sortEspontaneo=function(a){e.grilla.doSort("ESESPONTANEO",a)},e.sortCardinalidad=function(a){e.grilla.doSort("CARDINALIDAD",a)},e.sortDuracion=function(a){e.grilla.doSort("DURACION_SUGERIDA",a)},e.sortClasificacion=function(a){e.grilla.doSort("CTDA_ID",a)},e.sortNombre=function(a){e.grilla.doSort("NOMBRE",a)},e.select=new a.NeoSelect,e.select.cargar(),e.select.callbacks.seleccionado=function(a,b){b&&(e.grilla.paginaActual=1,e.grilla.establecimientoId=a,c.info("Cargando datos para "+e.select.elegido.DESCRIPCION,"Cargando..."),e.grilla.active=!0,e.grilla.reload(),e.editar.active=!0)},e.getNombreRem=function(a){var b=e.rems.filter(function(b){return b.Id==a});return b.length>0?b[0].Descripcion:""},e.getRemActivo=function(a){var b=a.filter(function(a){return 0==a.ELIMINADO});return b.length>0?b[0]:null},e.getNombreCardinalidad=function(a){return 0==a?"INDIVIDUAL":1==a?"GRUPAL":"COMUNITARIA"},e.getNombreBool=function(a){return 1==a?"SI":"NO"},e.getParseaNombre=function(a){return a.length<20?a:a.substring(0,20)+"..."},a.orderByAttr=function(a,b,c,d){if(!angular.isObject(a))return a;var e=[];for(var f in a)e.push(a[f]);return e.sort(function(a,e){return"int"==c.toLowerCase()?(a=parseInt(a[b]),e=parseInt(e[b]),"asc"==d.toLowerCase()?a-e:e-a):(a=a[b],e=e[b],"asc"==d.toLowerCase()?a.localeCompare(e):e.localeCompare(a))}),e},e}angular.module("mantenedorConsulta").controller("consultaController",a),a.$inject=["$rootScope","dataService","toastr","toastrNoDismiss"]}(),function(){"use strict";function a(a,b){a.state("er.parametros",{url:"/parametros",views:{"container@":{templateUrl:"parametros/mantenedor.parametros.view.html",controller:"parametrosController as adm"},"infoBarContainer@":{templateUrl:"parametros/mantenedor.parametros.infobar.html"}},data:{permisoEntrada:b.MANTENEDOR.LISTAR_PARAMETRO,titulo:"Parámetros"}})}angular.module("mantenedorParametros",["ui.router","sdx.Permissions"]).config(a),a.$inject=["$stateProvider","PERMISSIONS"];
}(),function(){"use strict";function a(a,b,c,d){a.showMenuMobile=!1;var e=this;return a.moduleTitle="Parámetros de Establecimientos",a.reset=function(a){a&&(a.$setPristine(),a.$setUntouched())},a.reset(),a.edit=function(a){$("#botonera-id-"+a+" .botonera-no-edicion").hide(),$("#botonera-id-"+a+" .botonera-edicion").show(),$("#data-id-"+a+" td .data").hide(),$("#data-id-"+a+" td .edit").show()},a.cancel=function(a){$("#botonera-id-"+a+" .botonera-no-edicion").show(),$("#botonera-id-"+a+" .botonera-edicion").hide(),$("#data-id-"+a+" td .data").show(),$("#data-id-"+a+" td .edit").hide()},a.save=function(a){e.editar.guardar(a,this.entrada)},e.getValorParametro=function(a){return""!=a.VALOR?3==a.MPY.MTP_ID?"1"==a.VALOR?"TRUE":"0"==a.VALOR?"FALSE":"":a.VALOR:""},e.getNombre=function(a){return a.length>30?a.substring(0,30)+"...":a},e.revisar=function(a){return 13==a.keyCode?(a.preventDefault(),!1):void 0},e.editar={active:!1,editar:function(b){a.edit(b.ID),e.editar.seleccionado=b},guardar:function(d,f){this.procesando||(d.prellenar?this.activar(d,f.valor):(this.procesando=!0,d.PRA.VALOR=f.valor,d.PRA.MODIFICADO_POR=a.user.data.FullName,b.putPRA(d.PRA).then(function(a){c.success("Se ha guardado el nuevo valor con éxito!","Éxito"),e.editar.procesando=!1,e.grilla.reload()})["catch"](function(a){c.error("Ocurrió un error al guardar el cambio de valor.","Error"),e.editar.procesando=!1})))},cancelar:function(b){b.prellenar&&(b.ELIMINADO=1),a.cancel(b.ID)},preLlenar:function(a){a.ELIMINADO=0,a.prellenar=!0,e.editar.editar(a)},activar:function(d,f){if(!this.procesando){if(this.procesando=!0,null!=d.PRA)d.PRA.ELIMINADO=0;else{var g={ELIMINADO:0,DESCRIPCION:d.NOMBRE,MPY_ID:d.ID,NOD_ID:e.grilla.establecimientoId,VALOR:f};d.PRA=g}b.putPRA(d.PRA,!0).then(function(b){a.closeModal("#confirmaEliminacion"),c.success("Parámetro activado con éxito","Éxito"),e.grilla.reload(),e.editar.procesando=!1})["catch"](function(a){c.error("Ocurrio un problema al actualizar","Error"),e.editar.procesando=!1}),d.PRA.ELIMINADO||null!=d.PRA.VALOR||c.error("Ha activado un parámetro que no tiene valor asignado!","Alerta")}},desactivar:function(){this.procesando||(this.procesando=!0,e.editar.seleccionado.PRA.ELIMINADO=1,b.putPRA(e.editar.seleccionado.PRA).then(function(b){a.closeModal("#confirmaEliminacion"),c.success("Parámetro desactivado con éxito","Éxito"),e.grilla.reload(),e.editar.procesando=!1})["catch"](function(a){c.error("Ocurrio un problema al actualizar","Error"),e.editar.procesando=!1}))},confirmarDesactivar:function(b){e.editar.seleccionado=b,a.showModal("#confirmaEliminacion")}},e.grilla=new a.NeoGrilla(b),e.grilla.active=!1,e.grilla.waiting=!1,e.grilla.largo=6,e.grilla.orden="NOMBRE",e.grilla.callback.getData=function(){b.getMPY(e.grilla.mostrando,e.grilla.paginaActual,e.grilla.searchTerms.length<4&&e.grilla.searchTerms.length>0?"":e.grilla.searchTerms).then(function(c){var d=c.data.filter(function(a){return a.NOMBRE.toLowerCase().includes(e.grilla.searchTerms.toLowerCase())});b.getPRA(e.grilla.establecimientoId).then(function(b){for(var c=b.data,f=[],g=[],h=0;h<d.length;h++){for(var i={ID:d[h].ID,NOMBRE:d[h].NOMBRE,DESCRIPCION:d[h].DESCRIPCION,TIPO:d[h].MTP_TIPO_PARAMETRO.NOMBRE,VALOR:"",ELIMINADO:1,MODIFICADO_POR:null,ULTIMA_ACTUALIZACION:"",MPY:d[h],PRA:null},j=!1,k=0;k<c.length;k++)if(d[h].ID==c[k].MPY_ID){j=!0;break}j&&(i.MODIFICADO_POR=c[k].MODIFICADO_POR,i.ULTIMA_ACTUALIZACION=null!=c[k].FECHA_ULTIMA_ACTUALIZACION?new Date(Date.parse(c[k].FECHA_ULTIMA_ACTUALIZACION.replace("T"," ")+" UTC")):"",i.VALOR=null==c[k].VALOR?"":c[k].VALOR,i.ELIMINADO=c[k].ELIMINADO,i.PRA=c[k]),f.push(i)}var l="string";("ID"==e.grilla.orden||"ELIMINADO"==e.grilla.orden)&&(l="int"),"ULTIMA_ACTUALIZACION"==e.grilla.orden&&(l="date"),f=a.orderByAttr(f,e.grilla.orden,l,e.grilla.ordenDireccion);var m=(e.grilla.paginaActual-1)*e.grilla.mostrando;f=f.slice(m,m+e.grilla.mostrando);for(var h=0;h<f.length;h++)g.push(f[h].MODIFICADO_POR);g=e.eliminarStringDuplicados(g),g.length>0?e.grilla.ds.getAccountUsers(g.toString()).then(function(a){for(var b=0;b<a.data.length;b++)for(var c=0;c<f.length;c++)f[c].MODIFICADO_POR==a.data[b].Id&&(f[c].NOMBRE_MODIFICADO=a.data[b].FullName);e.grilla.resultado=f,e.grilla.finishReload()}):(e.grilla.resultado=f,e.grilla.finishReload())})})},e.grilla.callback.getCountPaginacion=function(){e.grilla.ds.getCountMPY(e.grilla.searchTerms.length<4&&e.grilla.searchTerms.length>0?"":e.grilla.searchTerms).then(function(a){var b=a.data.filter(function(a){return a.NOMBRE.toLowerCase().includes(e.grilla.searchTerms.toLowerCase())}),c={data:b};e.grilla.finishPaginacion(c)})},e.sortParametro=function(a){e.grilla.doSort("NOMBRE",a)},e.sortValor=function(a){e.grilla.doSort("VALOR",a)},e.sortActivo=function(a){e.grilla.doSort("ELIMINADO",a)},e.sortFechaActualizacion=function(a){e.grilla.doSort("ULTIMA_ACTUALIZACION",a)},e.select=new a.NeoSelect,e.select.callbacks.seleccionado=function(a,b){b&&(e.grilla.paginaActual=1,e.grilla.establecimientoId=a,c.info("Cargando datos para "+e.select.elegido.DESCRIPCION,"Cargando..."),e.grilla.active=!0,e.grilla.reload(),e.editar.active=!0)},e.select.cargar(),e.eliminarStringDuplicados=function(a){for(var b=[],c=0;c<a.length;c++){var d=b.filter(function(b){return b==a[c]});0==d.length&&b.push(a[c])}return b},e}angular.module("mantenedorParametros").controller("parametrosController",a),a.$inject=["$rootScope","dataService","toastr","toastrNoDismiss"]}();